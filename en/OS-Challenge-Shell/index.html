<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s a private blog about a human being, welcome to subscribe!"/>
  <meta name="keyword" content="Learning,living,gaming"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://s7am1na.github.io/en/OS-Challenge-Shell/">
  <title>
    
      OS-Challenge:Shell - just a private corner
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">S7的温柔时空角</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: url('/img/header_img/OSshell.png');
      --intro-header-background-image-url-page: url('//img/header_img/OSshell.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/OSshell.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/OSshell.png');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/OSshell.png'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#OS" title="OS">OS</a>
              
            </div>
            <h1>OS-Challenge:Shell</h1>
            <h2 class="subheading">永别OS的一集</h2>
            <span class="meta">
              Posted by S7AM1NA on
              2025-06-27
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">11</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.1k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
 <!-- MathJax v3（推荐） -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <blockquote>
<p>今夕是何年。</p>
</blockquote>
<h1 id="零-前言">零 前言</h1>
<p>​
转眼就六月底放假了，大家每天聚在一起玩了三两天，假期生活就又要步入正轨了。那最后的最后残余的OS便是<strong>挑战性任务</strong>了，我写的是Shell的迭代开发，一路也是波折坎坷，下面请看笔者的Shell实验内容吧！</p>
<h1 id="壹-引言">壹 引言</h1>
<h2 id="项目背景"><strong>1.1 项目背景</strong></h2>
<p>​ MOS 操作系统实验基于Lab6的 Shell
环境，但其功能较为简陋，例如不支持相对路径、缺乏环境变量、命令行输入体验不佳等，这在实际使用中造成了诸多不便。我们的挑战性任务旨在克服这些局限，通过对
Shell 的深度改造，实现一个功能丰富、交互友好且行为符合 POSIX
标准的<strong>增强型 Shell</strong>。</p>
<h2 id="任务目标"><strong>1.2 任务目标</strong></h2>
<p>根据指导书要求，本次挑战性任务需完成以下几大模块的开发：</p>
<ol type="1">
<li><strong>路径支持</strong>：为进程引入工作目录（CWD）概念，实现
<code>cd</code>、<code>pwd</code>
内建指令，并使所有文件操作指令支持相对路径（包括 . 和 ..）。</li>
<li><strong>环境变量</strong>：实现
<code>declare</code>、<code>unset</code>
内建指令，支持局部、导出、只读三种变量属性，并能在子 Shell
中正确继承。</li>
<li><strong>输入优化</strong>：实现自由光标移动、行编辑快捷键（如
Ctrl-A/E/K/U/W）、历史指令回溯、命令自动补全 .b 后缀、注释功能。</li>
<li><strong>高级执行</strong>：实现反引号命令替换、分号多指令执行、&amp;&amp;
与 || 条件执行、&gt;&gt; 追加重定向。</li>
<li><strong>指令集扩充</strong>：实现 <code>touch</code>,
<code>mkdir</code>, <code>rm</code> 等常用外部指令，并支持相应选项（如
-p, -r, -f）。</li>
</ol>
<h2 id="技术选型"><strong>1.3 技术选型</strong></h2>
<p>鉴于任务的复杂性与指导书的提示，面对涉及
<code>&amp;&amp;</code>、<code>||</code>、<code>|</code>
和反引号等具有嵌套和优先级关系的语法，我们决定放弃原有的边解析边执行的简单模型。我们采用了更为健壮和可扩展的
<strong>“词法分析 -&gt; 语法分析（构建AST） -&gt; AST遍历执行”</strong>
的经典编译器前端设计模式。该模型将复杂的命令语句转化为结构化的数据（AST），极大地简化了后续的执行逻辑，并能自然地处理复杂的指令嵌套和执行顺序。</p>
<h1 id="贰-总体设计">贰 总体设计</h1>
<h2 id="核心流程"><strong>2.1 核心流程</strong></h2>
<p>我们设计的增强型 Shell 的主干执行流程遵循一个清晰的循环模式：</p>
<ol type="1">
<li><strong>读取输入 <code>readline</code></strong>：主进程循环调用
<code>readline</code>
函数，该函数负责处理所有底层用户交互，包括光标移动、快捷键和历史命令，最终返回一条完整的、用户确认的命令字符串。</li>
<li><strong>创建子进程 <code>fork</code></strong>：为保证主 Shell
的稳定，所有命令的解析和执行都在一个 fork 出的子 Shell 进程中完成。主
Shell 仅负责等待子进程结束，并管理历史记录。</li>
<li><strong>预处理
<code>preprocess_backquotes</code></strong>：在子进程中，首先对命令字符串进行预处理，主要处理反引号命令替换。</li>
<li><strong>解析构建AST
<code>parse_line</code></strong>：将预处理后的字符串交给递归下降解析器
<code>parse_line</code>，该解析器经过词法分析和语法分析，最终构建出一棵完整的抽象语法树（AST）。</li>
<li><strong>遍历执行AST
<code>run_ast</code></strong>：<code>run_ast</code> 函数递归地遍历 AST
的每个节点，根据节点类型（如 EXEC, PIPE, AND, OR
等）执行相应的操作，包括设置重定向、创建管道、管理进程和执行最终的命令。</li>
</ol>
<h2 id="ast为核心的解析与执行模型"><strong>2.2
AST为核心的解析与执行模型</strong></h2>
<p>我们参考指导书建议的 EBNF
文法，设计了AST的节点结构，并以此为基础构建了解析器和执行器。</p>
<h3 id="ast-节点定义"><strong>1. AST 节点定义</strong></h3>
<p>我们定义了三种基本的节点结构，所有节点共享一个通用的 type 头部：</p>
<ul>
<li><code>struct execcmd</code>: 表示一个简单命令，如
<code>ls -l</code>。包含 argv 数组。</li>
<li><code>struct redircmd</code>:
表示一个重定向命令，内含一个被重定向的子命令节点
<code>cmd</code>以及重定向信息（文件名、模式、fd）。</li>
<li><code>struct bincmd</code>: 表示一个二元命令，如管道、&amp;&amp;、||
等。包含左右两个子命令节点<code>left</code>, <code>right</code>。</li>
</ul>
<p>为了避免在内核中没有实现的
<code>malloc</code>，我们通过静态数组（<code>node_pool</code>,
<code>arg_pool</code>）构建了一个无动态内存分配的节点和参数池，确保了内存管理的简洁与安全。</p>
<h3 id="递归下降解析"><strong>2. 递归下降解析</strong></h3>
<p>我们实现了一套自上而下的递归下降解析器。例如，<code>parse_list</code>
函数负责解析 <code>;</code>，它会调用 <code>parse_and_or</code>
来解析其操作数；<code>parse_and_or</code> 则调用
<code>parse_pipeline</code>，层层递进，完美地实现了操作符的优先级（|
&gt; &amp;&amp;/|| &gt; ;）。</p>
<h3 id="ast-遍历执行"><strong>3. AST 遍历执行</strong></h3>
<p><code>run_ast</code>
函数是执行引擎的核心，部分代码如下。它通过一个大的 switch
语句，根据当前节点的 type 来决定行为：</p>
<ul>
<li><strong>EXEC
节点</strong>：检查是否为内建指令。若是，则直接调用相应处理函数；若不是，则通过
spawn 创建新进程执行外部命令。</li>
<li><strong>PIPE 节点</strong>：创建管道，fork
两个子进程分别执行左右子树，并通过 dup
将它们的标准输入/输出连接到管道两端。</li>
<li><strong>REDIR 节点</strong>：在执行子命令前，先打开重定向文件并使用
dup 将标准输入/输出重定向。</li>
<li><strong>AND/OR 节点</strong>：先 fork 执行左子树，wait
获取其退出状态码，然后根据状态码和节点类型（&amp;&amp; 或
||）决定是否继续执行右子树。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">switch</span>(cmd-&gt;type) &#123;</span><br><span class="line">	<span class="keyword">case</span> EXEC: <span class="comment">// 简单指令</span></span><br><span class="line">	<span class="keyword">case</span> REDIR: <span class="comment">// 重定向</span></span><br><span class="line">	<span class="keyword">case</span> REDIR_APPEND: <span class="comment">// 追加重定向</span></span><br><span class="line">	<span class="keyword">case</span> PIPE: <span class="comment">// 管道</span></span><br><span class="line">	<span class="keyword">case</span> LIST: <span class="comment">// 多指令</span></span><br><span class="line">	<span class="keyword">case</span> AND: <span class="comment">// &amp;&amp;</span></span><br><span class="line">	<span class="keyword">case</span> OR: <span class="comment">// ||</span></span><br><span class="line">    <span class="keyword">default</span>: user_panic(<span class="string">&quot;unknown AST node type %d\n&quot;</span>, cmd-&gt;type);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exit</span>();</span><br></pre></td></tr></table></figure>
<h1 id="叁-关键功能实现"><strong>叁 关键功能实现</strong></h1>
<h2 id="支持相对路径与工作目录"><strong>3.1
支持相对路径与工作目录</strong></h2>
<ul>
<li><strong>工作目录管理</strong>：我们在内核的进程控制块（struct
Env）中增加了一个字段来存储每个进程的当前工作目录（CWD）。</li>
<li><strong>内建指令 <code>cd</code></strong>：cd
是一个特殊的内建指令。它在 fork 出的子 Shell
中被识别，但其核心逻辑是通过一个我们新增的系统调用
<code>syscall_set_cwd(parent_envid, path)</code>
来修改<strong>父进程（主 Shell）</strong>的工作目录，从而实现 cd
命令的持久化效果。</li>
<li><strong>内建指令 <code>pwd</code></strong>：pwd 通过
<code>syscall_get_cwd(0, ...)</code> 获取并打印当前进程的 CWD。</li>
<li><strong>路径解析</strong>：我们实现了一个
<code>normalize_path</code>
辅助函数。该函数接收一个任意路径（绝对或相对）和当前工作目录，通过状态机解析路径中的
. 和 ..，最终生成一个规范化的绝对路径，供所有文件操作（open, spawn
等）使用。</li>
</ul>
<h4 id="环境变量管理"><strong>3.2 环境变量管理</strong></h4>
<ul>
<li><strong>内存模型与继承</strong>：我们环境变量的实现利用了 MOS
的内存管理机制。在顶级 Shell 启动时，<code>init_environs</code>
函数会分配一页内存，并将其以 <em>PTE_LIBRARY</em>
标志映射到固定的虚拟地址 <em>ENV_VAR_VA</em>。<em>PTE_LIBRARY</em>
使得子进程在 fork
时与父进程共享此物理内存页，并将其权限降为只读，实现了高效的继承。当子进程试图修改环境变量（写入共享页）时，会触发写时复制<code>CoW</code>，从而获得自己的私有副本，保证了对父
Shell 的隔离。</li>
<li><strong>declare 与 unset</strong>：<code>declare</code> 指令通过解析
-x（导出）和 -r（只读）选项来设置 struct Var 中的标志位。unset
则通过清除变量的 <em>VAR_FLAG_VALID</em> 标志来实现逻辑删除。</li>
</ul>
<h4 id="输入指令优化"><strong>3.3 输入指令优化</strong></h4>
<ul>
<li><strong>行编辑与历史指令</strong>：<code>readline</code>
函数是该模块的核心。它工作在"raw mode"，逐字符读取输入。通过一个大的
switch
语句，它响应普通字符（插入）、退格（删除）、方向键（移动光标）和所有
Ctrl 快捷键，并在每次按键后调用 draw_line
重绘整行，实现了流畅的行编辑体验。历史指令通过一个全局数组 history_buf
和一个文件 /.mosh_history 进行管理，<code>readline</code>
通过修改历史指针 <code>history_inst</code> 来实现历史命令的切换。</li>
<li><strong>其他优化</strong>：
<ul>
<li><strong>.b 后缀</strong>：在 run_ast 的 EXEC
节点处理中，如果待执行的命令不含 / 且不以 .b 结尾，则自动为其拼接上 / 和
.b 后缀。</li>
<li><strong>注释</strong>：在 main 函数中，<code>readline</code>
返回后，在 fork 之前，通过 strchr 查找 # 并将其替换为
\0，简单高效地实现了注释功能。</li>
</ul></li>
</ul>
<h4 id="高级指令执行"><strong>3.4 高级指令执行</strong></h4>
<ul>
<li>**反引号
`<code>**：</code>preprocess_backquotes<code>函数通过扫描字符串实现。当遇到一对反引号时，它会截取内部的子命令，**递归地调用</code>parse_line<code>和</code>run_and_capture<code>**。</code>run_and_capture<code>函数通过</code>pipe<code>创建管道，</code>fork`
子进程执行子命令的
AST，并将子进程的标准输出重定向到管道写端；父进程则从管道读端捕获所有输出，并将其替换回原命令字符串中的反引号部分。</li>
<li><strong>条件执行 &amp;&amp; 与
||</strong>：该功能的关键在于<strong>进程退出状态码的正确传递</strong>。<code>run_ast</code>
在处理 AND/OR 节点时，会 fork-exec 左侧命令，然后调用
<code>wait_with_status</code> 等待并获取其退出状态码 status。最后，根据
(status == 0)（对于&amp;&amp;）或 (status !=
0)（对于||）的布尔结果，决定是否继续执行右侧子树。</li>
<li><strong>追加重定向 &gt;&gt;</strong>：我们为 REDIR 节点增加了一个
REDIR_APPEND 类型。在 run_ast 中，如果节点是此类型，在 open
文件后，会额外调用 <code>fstat</code> 获取文件大小，然后 seek
到文件末尾，再执行后续的 dup 和子命令，从而实现了追加写入。</li>
</ul>
<h1 id="肆-炒鸡离谱的bug">肆 炒鸡离谱的bug</h1>
<p>​
先说根本原因，笔者没有注意到<code>history</code>指令要输出自身<code>history</code>，导致我在重构完AST语法树后第三个关于<strong>历史指令</strong>的测试点无法通过。</p>
<p>​
那你可能会好奇了，难道说我在重构前可以通过第三个测试点吗？你别说，你还真别说，重构前还真过了！🧐于是我debug的思路就是反复对比重构前后的区别是什么？</p>
<p>​
后来我把bug的范围逐步缩小至<code>run_ast</code>中的<code>EXEC</code>分支，无意间发现我修改了之前的错误写法：</p>
<figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ecmd-&gt;argv[<span class="number">0</span>] == <span class="type">NULL</span>) &#123;</span><br><span class="line">             exit(); // 空命令，直接退出</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         // --- 内建命令统一处理 ---</span><br><span class="line">         // 变量定义</span><br><span class="line"></span><br><span class="line">         // exit: 必须最先处理，因为它会立即终止进程</span><br><span class="line">         <span class="keyword">if</span> (strcmp(ecmd-&gt;argv[<span class="number">0</span>], <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span>) <span class="meta">&#123;...&#125;</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (strcmp(ecmd-&gt;argv[<span class="number">0</span>], <span class="string">&quot;cd&quot;</span>) == <span class="number">0</span>) <span class="meta">&#123;...&#125;</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (strcmp(ecmd-&gt;argv[<span class="number">0</span>], <span class="string">&quot;declare&quot;</span>) == <span class="number">0</span>) <span class="meta">&#123;...&#125;</span></span><br><span class="line">         // 等等内置指令</span><br><span class="line">         // --- 内置指令执行结束 ---</span><br><span class="line">         // --- 外部命令执行 ---</span><br><span class="line">         // ...</span><br><span class="line">         	<span class="type">int</span> child_pid = spawn(prog_path, ecmd-&gt;argv);</span><br><span class="line">             <span class="keyword">if</span> (child_pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                 // spawn失败，通常意味着程序文件不存在或无权限</span><br><span class="line">                 printf(<span class="string">&quot;sh: command not found or cannot execute: %s\n&quot;</span>, ecmd-&gt;argv[<span class="number">0</span>]);</span><br><span class="line">                 exit_with_status(<span class="number">127</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         // ...    </span><br></pre></td></tr></table></figure>
<p>​
这意味着什么呢？我们的内置指令history也会进入外置指令的处理流程中，而由于没有<code>history.c</code>文件，<code>spawn</code>一定会失败！</p>
<p>​ 当我们的指令序列如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> dir1</span><br><span class="line"><span class="built_in">cd</span> dir1</span><br><span class="line"><span class="built_in">history</span></span><br></pre></td></tr></table></figure>
<p>​ 我们的<code>history</code>指令输出如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> dir1</span><br><span class="line"><span class="built_in">cd</span> dir1</span><br><span class="line">sh: <span class="built_in">command</span> not found or cannot execute: <span class="built_in">history</span></span><br></pre></td></tr></table></figure>
<p>​
！！！⚠原来评测机使用的是字符串匹配！history被检测到误判成正确的了。</p>
<p>以至于后来我将这个<strong>内置指令进入外置指令处理流程</strong>的这个bug修复之后过不了第三个测试点的评测！真是一次令人刻骨铭心的记忆！也是成功卡了我两天😭</p>
<h1 id="伍-总结"><strong>伍 总结</strong></h1>
<p>​ 通过本次挑战性任务，我们成功地将一个<del>功能简陋</del>的 MOS Shell
改造为了一个<del>健壮、功能丰富的现代化命令行工具</del>。我们通过引入
AST
模型，构建了清晰、可扩展的程序架构。在实现相对路径、环境变量、高级输入和复杂流控制等功能的过程中，我们不仅加深了对
Shell
工作原理的理解，更在实践中掌握了进程通信、内存共享、系统调用等核心操作系统概念。特别是<code>history</code>指令报错问题的过程，让我们体会到了git的重要性并且得知了一种新的bug触发方式。最终，我们的
Shell 顺利通过了所有自动化评测，圆满完成了本次挑战。</p>
<p>​ 再见MOS！再见OS！👋</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/暑期GNSS学习工作记录-持续更新/" data-toggle="tooltip" data-placement="top" title="暑期GNSS学习工作记录(持续更新)">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/但愿身强健-浮世拚悠悠/" data-toggle="tooltip" data-placement="top" title="但愿身强健 浮世拚悠悠">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Fri Jun 27 2025 10:19:53 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E9%9B%B6-%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">零 前言</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%A3%B9-%E5%BC%95%E8%A8%80"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">壹 引言</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">1.1 项目背景</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%9B%AE%E6%A0%87"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">1.2 任务目标</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">1.3 技术选型</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E8%B4%B0-%E6%80%BB%E4%BD%93%E8%AE%BE%E8%AE%A1"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">贰 总体设计</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">2.1 核心流程</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ast%E4%B8%BA%E6%A0%B8%E5%BF%83%E7%9A%84%E8%A7%A3%E6%9E%90%E4%B8%8E%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">2.2
AST为核心的解析与执行模型</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ast-%E8%8A%82%E7%82%B9%E5%AE%9A%E4%B9%89"><span class="toc-nav-number">3.2.1.</span> <span class="toc-nav-text">1. AST 节点定义</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E8%A7%A3%E6%9E%90"><span class="toc-nav-number">3.2.2.</span> <span class="toc-nav-text">2. 递归下降解析</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ast-%E9%81%8D%E5%8E%86%E6%89%A7%E8%A1%8C"><span class="toc-nav-number">3.2.3.</span> <span class="toc-nav-text">3. AST 遍历执行</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E5%8F%81-%E5%85%B3%E9%94%AE%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">叁 关键功能实现</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%94%AF%E6%8C%81%E7%9B%B8%E5%AF%B9%E8%B7%AF%E5%BE%84%E4%B8%8E%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">3.1
支持相对路径与工作目录</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-nav-number">4.1.0.1.</span> <span class="toc-nav-text">3.2 环境变量管理</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%BE%93%E5%85%A5%E6%8C%87%E4%BB%A4%E4%BC%98%E5%8C%96"><span class="toc-nav-number">4.1.0.2.</span> <span class="toc-nav-text">3.3 输入指令优化</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%AB%98%E7%BA%A7%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-nav-number">4.1.0.3.</span> <span class="toc-nav-text">3.4 高级指令执行</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E8%82%86-%E7%82%92%E9%B8%A1%E7%A6%BB%E8%B0%B1%E7%9A%84bug"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">肆 炒鸡离谱的bug</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#%E4%BC%8D-%E6%80%BB%E7%BB%93"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">伍 总结</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#OS" title="OS">OS</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/S7AM1NA">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          S7AM1NA
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://s7am1na.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
