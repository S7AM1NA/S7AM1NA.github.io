<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s a private blog about a human being, welcome to subscribe!"/>
  <meta name="keyword" content="Learning,living,gaming"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://s7am1na.github.io/en/BUAA-OSLab3实验总结/">
  <title>
    
      BUAA-OSLab3实验总结 - just a private corner
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">S7的温柔时空角</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: url('/img/header_img/ghost_blade5.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/ghost_blade5.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/ghost_blade5.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/ghost_blade5.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/ghost_blade5.jpg'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#OS" title="OS">OS</a>
              
            </div>
            <h1>BUAA-OSLab3实验总结</h1>
            <h2 class="subheading">人生本来就是多进程的，你做好管理了吗？</h2>
            <span class="meta">
              Posted by S7AM1NA on
              2025-04-21
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">17</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">4.5k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
 <!-- MathJax v3（推荐） -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="buaa-oslab3实验总结进程管理">BUAA-OSLab3实验总结——进程管理</h1>
<blockquote>
<p>固执不是傻，高歌到沙哑。</p>
</blockquote>
<h2 id="前言">前言</h2>
<p>​
这几天下了<strong>一阵阵小雨</strong>，風船说湿润了一些，很喜欢下雨天。</p>
<p>​
我倒是感觉很<strong>困</strong>😴，人怎么能困成这样😭。索性让自己睡饱了，半下午来到图书馆开始学一下Lab3🤔。</p>
<p>​ 那为什么这次的博客从周一开始写呢🙋‍？</p>
<p>​
因为笔者这次lab3实验想做一次记录性博客，从一个初学者的视角去展示这段旅程🖊，而不是学完之后的回顾总结。那事不宜迟，GoGoGo！出发咯！😀</p>
<h2 id="征途中的迷思与thinking">征途中的迷思与Thinking</h2>
<h3 id="迷思一-模板页目录base_pgdir">🧐迷思一
模板页目录(base_pgdir)</h3>
<p>​ 请看相关<strong>注释</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We want to map &#x27;UPAGES&#x27; and &#x27;UENVS&#x27; to *every* user space with PTE_G permission (without PTE_D), then user programs can read (but cannot write) kernel data structures &#x27;pages&#x27; and&#x27;envs&#x27;.</span></span><br><span class="line"><span class="comment"> * Here we first map them into the *template* page directory &#x27;base_pgdir&#x27;.</span></span><br><span class="line"><span class="comment"> * Later in &#x27;env_setup_vm&#x27;, we will copy them into each &#x27;env_pgdir&#x27;.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="先问是什么">1 先问是什么？</h4>
<ul>
<li>base_pgdir 本质上是一个<strong>页目录 (Page
Directory)</strong>。就是我们多级页表结构中的<strong>一级页表</strong>。</li>
<li>它被称为“模板”（Template）是因为它<strong>不直接</strong>被任何一个正在运行的用户进程（Env）使用。相反，它包含了一些<strong>所有用户进程都应该拥有的通用内存映射</strong>。</li>
<li>可以把它想象成一个预先配置好的蓝图或模板，用于快速创建新进程的地址空间。</li>
</ul>
<h4 id="再问为什么这样设计">2 再问为什么（这样设计）？</h4>
<ul>
<li><strong>高效率:</strong>
当创建一个新的进程时，需要为这个进程设置它自己的虚拟地址空间，也就是要创建并填充它自己的页目录
(env_pgdir)。有很多内存区域的映射对于所有用户进程来说都是相同的，如果每次创建新进程时，都从头开始、逐一添加这些通用映射，会非常低效。使用模板页目录，可以<strong>在初始化时就把这些通用映射设置好</strong>。之后创建新进程时，只需将
base_pgdir 的内容<strong>复制</strong>到新进程的 env_pgdir
中，然后再添加该进程特有的映射（如代码段、数据段、栈等）。这大大<strong>加快了进程虚拟内存初始化的速度</strong>。</li>
<li><strong>共享内核数据:</strong>
如<strong>注释（代码段）</strong>中所述，操作系统设计者希望让用户程序能够<strong>读取（但不能写入）</strong>某些内核维护的数据结构，比如
pages 数组（描述所有物理页的状态）和 envs
数组（描述所有进程控制块的状态）。这对于实现某些用户态的功能（如用户级调试器、性能监控工具或某些IPC机制）可能很有用。将这些数据映射到<em>每个</em>用户进程的地址空间中，并且使用相同的虚拟地址（UPAGES,
UENVS），可以简化用户程序的编写。</li>
</ul>
<h4 id="为这段代码逐行注释">3 为这段代码逐行注释</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分配一个物理页框p</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span>;</span></span><br><span class="line">panic_on(page_alloc(&amp;p));</span><br><span class="line">p-&gt;pp_ref++;</span><br><span class="line"></span><br><span class="line">base_pgdir = (Pde *)page2kva(p); <span class="comment">// 转化为内核虚拟地址</span></span><br><span class="line"><span class="comment">// map_segment : 用于在 base_pgdir 中建立一段虚拟内存到物理内存的映射。</span></span><br><span class="line">map_segment(base_pgdir, <span class="number">0</span>, PADDR(pages), UPAGES,</span><br><span class="line">	    ROUND(npage * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Page), PAGE_SIZE), PTE_G);</span><br><span class="line">map_segment(base_pgdir, <span class="number">0</span>, PADDR(envs), UENVS, ROUND(NENV * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env), 		PAGE_SIZE),PTE_G);</span><br></pre></td></tr></table></figure>
<h3 id="迷思二-env_setup_vm-函数">🧐迷思二 env_setup_vm 函数</h3>
<p>​ 先看看源码（补全版✔）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">env_setup_vm</span><span class="params">(<span class="keyword">struct</span> Env *e)</span> &#123;</span><br><span class="line">	<span class="comment">/* Step 1:</span></span><br><span class="line"><span class="comment">	 *   Allocate a page for the page directory with &#x27;page_alloc&#x27;.</span></span><br><span class="line"><span class="comment">	 *   Increase its &#x27;pp_ref&#x27; and assign its kernel address to &#x27;e-&gt;env_pgdir&#x27;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Hint:</span></span><br><span class="line"><span class="comment">	 *   You can get the kernel address of a specified physical page using &#x27;page2kva&#x27;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Page</span> *<span class="title">p</span>;</span></span><br><span class="line">	try(page_alloc(&amp;p));</span><br><span class="line">	<span class="comment">/* Exercise 3.3: Your code here. */</span></span><br><span class="line">	p-&gt;pp_ref++;</span><br><span class="line"> 	e-&gt;env_pgdir = (Pde *)page2kva(p);</span><br><span class="line">	<span class="comment">/* Step 2: Copy the template page directory &#x27;base_pgdir&#x27; to &#x27;e-&gt;env_pgdir&#x27;. */</span></span><br><span class="line">	<span class="comment">/* Hint:</span></span><br><span class="line"><span class="comment">	 *   As a result, the address space of all envs is identical in [UTOP, UVPT).</span></span><br><span class="line"><span class="comment">	 *   See include/mmu.h for layout.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">memcpy</span>(e-&gt;env_pgdir + PDX(UTOP), base_pgdir + PDX(UTOP),</span><br><span class="line">	       <span class="keyword">sizeof</span>(Pde) * (PDX(UVPT) - PDX(UTOP)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Step 3: Map its own page table at &#x27;UVPT&#x27; with readonly permission.</span></span><br><span class="line"><span class="comment">	 * As a result, user programs can read its page table through &#x27;UVPT&#x27; */</span></span><br><span class="line">	e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_V;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​
首先，<code>Step1</code>在注释的帮助下很好理解：为进程e分配一个物理页框<code>p</code>并以之作为页目录，并且用<code>e-&gt;env_pgdir</code>记录内核访问该页目录<code>p</code>的虚拟地址。</p>
<p>​ <code>Step2</code>的注释说 <em>“Copy the template page
directory”</em>，那我们知道了，要用<strong>模板页目录</strong>
“批量生产” 页目录了！</p>
<p>​
但是随之而来的是看不懂的<code>memcpy</code>括号里的各路参数🫠，什么<code>UTOP</code>哇什么<code>UVPT</code>哇...</p>
<p>​
你在OS中高声呼救，回应你的只有【<strong>Hint</strong>】...（好叭其实是我眼瞎）😓</p>
<p>​ 那我们CV一段<code>layout</code>看看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">o      ULIM     -----&gt; +----------------------------+-----------<span class="number">-0x8000</span> <span class="number">0000</span>-------</span><br><span class="line">o                      |         User VPT           |     PDMAP                /|\</span><br><span class="line">o      UVPT     -----&gt; +----------------------------+-----------<span class="number">-0x7fc0</span> <span class="number">0000</span>    |</span><br><span class="line">o                      |           pages            |     PDMAP                 |</span><br><span class="line">o      UPAGES   -----&gt; +----------------------------+-----------<span class="number">-0x7f80</span> <span class="number">0000</span>    |</span><br><span class="line">o                      |           envs             |     PDMAP                 |</span><br><span class="line">o  UTOP,UENVS   -----&gt; +----------------------------+-----------<span class="number">-0x7f40</span> <span class="number">0000</span>    |</span><br></pre></td></tr></table></figure>
<p>​ 原来这是一段虚拟地址😌。</p>
<p>​
这个虚拟地址范围本身<strong>并不直接存储</strong>任何数据，它只是一个<strong>地址空间区域</strong>。关键在于，在
<code>env_setup_vm</code> 中，通过 <code>memcpy</code> 从
<code>base_pgdir</code> 复制过来的<strong>页目录项
(PDEs)</strong>，为这个范围内的<strong>特定虚拟地址</strong>（如 UPAGES,
UENVS）<strong>建立了映射</strong>。这个映射关系大概就是以下两种：（其中用户地址都是虚拟地址）</p>
<ul>
<li><p><strong>进程 e 的用户地址 UPAGES</strong> &lt;----(通过
e-&gt;env_pgdir 中复制来的 PDE)----&gt; <strong>物理地址
PADDR(pages)</strong> (只读)</p></li>
<li><p><strong>进程 e 的用户地址 UENVS</strong> &lt;----(通过
e-&gt;env_pgdir 中复制来的 PDE)----&gt; <strong>物理地址
PADDR(envs)</strong> (只读)</p></li>
</ul>
<p>​
这就是我们在上一个迷思提到的<strong>高效性</strong>。以<code>base_pgdir</code>为模板通过<code>memcpy</code>快速初始化，而不是逐一调用<code>map_segment</code>函数创建映射。</p>
<p>​
<code>Step3</code>和思考题撞了，请直接看下面<code>Thinking3.1</code>！</p>
<h3 id="thinking3.1">🤔Thinking3.1</h3>
<blockquote>
<p>请结合 MOS 中的页目录自映射应用解释代码中 e-&gt;env_pgdir[PDX(UVPT)]
= PADDR(e-&gt;env_pgdir) | PTE_V 的含义。</p>
</blockquote>
<p>​
让我们时刻记得<strong>自映射</strong>的目标：<strong>让进程能通过虚拟地址
UVPT 这个“窗口”来访问它自己的页目录和页表</strong>。</p>
<ol type="1">
<li><p><code>e-&gt;env_pgdir</code>：进程<code>e</code>的页目录数组指针，其中包含了1024个<code>PDE</code>，每个<code>PDE</code>负责管理4MB的虚拟地址空间。</p></li>
<li><p><code>PDX(UVPT)</code>：管理<code>UVPT</code>所在的4MB虚拟地址空间的那个<code>PDE</code>的索引。</p></li>
<li><p><code>PADDR(e-&gt;env_pgdir)</code>：页目录内核虚拟地址对应的物理地址，也就是找到存储<code>e</code>的页目录那4KB的物理页框的真实物理地址。</p></li>
<li><p><code>| PTE_V</code>：与页目录的物理地址合并一起，置有效位。</p>
<p>那自映射的实现最后是怎样的？我们在进程<code>e</code>
的页目录中创建了一个<strong>“精妙”的入口</strong>🚪：</p>
<ul>
<li><strong>入口的位置:</strong> 由虚拟地址 UVPT 决定的那个 PDE（索引为
<code>PDX(UVPT)</code>）。</li>
<li><strong>入口指向哪里:</strong>
指向页目录<strong>自己</strong>所在的物理地址
(<code>PADDR(e-&gt;env_pgdir)</code>)。</li>
<li><strong>入口的状态:</strong> 是有效的 (<code>PTE_V</code>)。</li>
</ul>
<p>那自映射的效果是什么？我认为自映射就是让第一级页目录在<code>UVPT</code>这个用户态的虚拟地址下变得“可见”，允许用户直接读取其中的<strong>PDEs</strong>。</p></li>
</ol>
<h3 id="thinking3.2">🤔Thinking3.2</h3>
<blockquote>
<p>elf_load_seg 以函数指针的形式，接受外部自定义的回调函数 map_page。
请你找到与之相关的 data
这一参数在此处的来源，并思考它的作用。没有这个参数可不可以？为什么？</p>
</blockquote>
<p>​ 先看<code>elf_load_seg</code>的声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">elf_load_seg</span><span class="params">(Elf32_Phdr *ph, <span class="type">const</span> <span class="type">void</span> *bin, <span class="type">elf_mapper_t</span> map_page, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure>
<p>​ 指导书指出：<code>elf_load_seg</code> 负责将 ELF 文件的一个 segment
加载到内存。为了实现这一功能，需要使用一个回调函数<code>map_page</code>，并将额外参数<code>data</code>传给它。当<code>elf_load_seg</code>解析到一个需要被加载到内存中的页面，就会由这个<code>map_page</code>来完成此页面的加载过程。那这里指导书的言外之意已经呼之欲出了，<code>data</code>作为传入<code>map_page</code>的参数一定是<strong>协助页面加载</strong>的。</p>
<p>​
另外指导书也指出<code>load_icode</code>对<code>elf_load_seg</code>的调用关系，我们决定层层深入，先看<code>load_icode</code>，找到了调用的语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic_on(elf_load_seg(ph, binary + ph-&gt;p_offset, load_icode_mapper, e));</span><br></pre></td></tr></table></figure>
<p>​
😮我们发现<code>data</code>在这里的赋值就是PCB的指针<code>e</code>，而正如指导书所述，<code>load_icode_mapper</code>
就是 <code>map_page</code>
的具体实现。我们再看<code>elf_load_seg</code>的实现，发现<code>data</code>出现且仅出现在map_page的参数中。那我们可以直接进入自定义的回调函数<code>load_icode_mapper</code>探寻<code>data</code>的作用了。</p>
<p>​ <code>load_icode_mapper</code>部分代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">load_icode_mapper</span><span class="params">(<span class="type">void</span> *data, u_long va, <span class="type">size_t</span> offset, u_int perm, <span class="type">const</span> <span class="type">void</span> *src, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">            <span class="comment">/*	data:通用上下文指针，这里就是进程控制块的指针 e</span></span><br><span class="line"><span class="comment">                va:需要进行映射的目标虚拟地址</span></span><br><span class="line"><span class="comment">                offset:当前要处理的数据块 (由 src 指向，长度为 len) 在整个ELF程序段内的字节偏移量</span></span><br><span class="line"><span class="comment">                perm:为虚拟地址 va 映射到的物理页面所要设置的访问权限</span></span><br><span class="line"><span class="comment">                src:指向源数据的指针。这些数据位于内存中加载的原始 ELF 文件二进制内容中</span></span><br><span class="line"><span class="comment">                len:需要从 src 拷贝到新分配物理页面的数据字节数</span></span><br><span class="line"><span class="comment">            */</span> </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env</span> =</span> (<span class="keyword">struct</span> Env *)data;</span><br><span class="line">	<span class="comment">// some definition...</span></span><br><span class="line">	<span class="comment">/* Step 1: Allocate a page with &#x27;page_alloc&#x27;. */</span></span><br><span class="line">	<span class="comment">/* Step 2: If &#x27;src&#x27; is not NULL, copy the &#x27;len&#x27; bytes started at &#x27;src&#x27; into &#x27;offset&#x27; at this * page. */</span></span><br><span class="line">	<span class="comment">/* Step 3: Insert &#x27;p&#x27; into &#x27;env-&gt;env_pgdir&#x27; at &#x27;va&#x27; with &#x27;perm&#x27;. */</span></span><br><span class="line">	<span class="keyword">return</span> page_insert(env-&gt;env_pgdir, env-&gt;env_asid, p, va, perm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​
可以看到我们在用<code>page_insert</code>建立虚拟地址与物理地址的映射的时候，用到了当前进程空间的页目录基地址(<code>pgdir</code>)和<code>asid</code>，倘若没有上下文指针<code>data</code>，自然就找不到这个PCB的这两个参数了。因此没有这两个参数是万万不行的。</p>
<h3 id="thinking3.3">🤔Thinking3.3</h3>
<blockquote>
<p>结合 elf_load_seg
的参数和实现，考虑该函数需要处理哪些页面加载的情况。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 段起始于页面中</span></span><br><span class="line"><span class="keyword">if</span> (offset != <span class="number">0</span>) &#123;  </span><br><span class="line">	<span class="keyword">if</span> ((r = map_page(data, va, offset, perm, bin, </span><br><span class="line">           MIN(bin_size, PAGE_SIZE - offset))) != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			MIN(bin_size, PAGE_SIZE - offset): 需要从 bin 拷贝的数据量</span></span><br><span class="line"><span class="comment">			根据剩余的 bin数据量判断是：</span></span><br><span class="line"><span class="comment">			1. 填满页剩余的部分</span></span><br><span class="line"><span class="comment">			2. 将极小的 bin中所有的数据量全部拷贝进当前页</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">return</span> r; <span class="comment">// 建立映射失败，返回错误码</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Step 1: load all content of bin into memory. */</span></span><br><span class="line"><span class="comment">// i作为拷贝起点，根据前段代码中是否存在offset导致先拷贝一部分数据</span></span><br><span class="line"><span class="comment">// i += PAGE_SIZE即按页复制，直到剩余数据不足以填满一整页</span></span><br><span class="line"><span class="keyword">for</span> (i = offset ? MIN(bin_size, PAGE_SIZE - offset) : <span class="number">0</span>; i &lt; bin_size; i += PAGE_SIZE) &#123;</span><br><span class="line">	<span class="keyword">if</span> ((r = map_page(data, va + i, <span class="number">0</span>, perm, bin + i, MIN(bin_size - i, PAGE_SIZE))) != <span class="number">0</span>) 	&#123;</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Step 2: alloc pages to reach `sgsize` when `bin_size` &lt; `sgsize`. */</span></span><br><span class="line"><span class="comment">// i &lt; sgsize说明还有内存空间需要分配并清零</span></span><br><span class="line"><span class="keyword">while</span> (i &lt; sgsize) &#123;</span><br><span class="line">	<span class="comment">// 用 NULL告诉`map_page`只需要分配全0的物理页面即可，无需拷贝数据</span></span><br><span class="line">	<span class="keyword">if</span> ((r = map_page(data, va + i, <span class="number">0</span>, perm, <span class="literal">NULL</span>, MIN(sgsize - i, PAGE_SIZE))) != <span class="number">0</span>) 		&#123;</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">	i += PAGE_SIZE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Step0</code>：函数判断va是否页对齐，如果不对齐，需要将多余的地址记为offset，并且先拷贝一部分的数据；</li>
<li><code>Step1</code>：按页将段内的数据映射到物理空间；</li>
<li><code>Step2</code>：若发现其在内存的大小大于在文件中的大小，则需要把多余的空间用0填满。</li>
</ul>
<h3 id="thinking3.4">🤔Thinking3.4</h3>
<blockquote>
<p>这里的 env_tf.cp0_epc 字段指示了进程恢复运行时 PC
应恢复到的位置。我们要运行的
进程的代码段预先被载入到了内存中，且程序入口为
e_entry，当我们运行进程时，CPU 将自动从 PC
所指的位置开始执行二进制码。</p>
<p>思考上面这一段话，并根据自己在 Lab2 中的理解，回答： 你认为这里的
env_tf.cp0_epc 存储的是物理地址还是虚拟地址?</p>
</blockquote>
<p>​
<strong>虚拟地址</strong>；<code>cp0_epc</code>中存储的是发生错误时CPU所处的指令地址，CPU所见的均为虚拟地址。</p>
<h3 id="thinking3.5">🤔Thinking3.5</h3>
<blockquote>
<p>试找出 0、1、2、3 号异常处理函数的具体实现位置。8 号异常（系统调用）
涉及的 do_syscall() 函数将在 Lab4 中实现。</p>
</blockquote>
<p>​
既然异常处理函数要和CPU的协处理器打交道，那大概率是用汇编写的<code>.S</code>文件啦😊。我们在<code>genex.S</code>文件中找到了<code>handle_int</code>。</p>
<p>​ 但是没找到其余的异常处理？定睛一看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.macro BUILD_HANDLER exception handler</span><br><span class="line">NESTED(handle_\exception, TF_SIZE + 8, zero)</span><br><span class="line">	move    a0, sp</span><br><span class="line">	addiu   sp, sp, -8</span><br><span class="line">	jal     \handler</span><br><span class="line">	addiu   sp, sp, 8</span><br><span class="line">	j       ret_from_exception</span><br><span class="line">END(handle_\exception)</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">BUILD_HANDLER tlb do_tlb_refill</span><br><span class="line"></span><br><span class="line">#if !defined(LAB) || LAB &gt;= 4</span><br><span class="line">BUILD_HANDLER mod do_tlb_mod</span><br><span class="line">BUILD_HANDLER sys do_syscall</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">BUILD_HANDLER reserved do_reserved</span><br></pre></td></tr></table></figure>
<p>​
原来如此，这个宏定义竟然定义了一段<strong>汇编入口包装器</strong>，但他们终究会通过<code>jal     \handler</code>进行跳转，而这段代码怎么会叫<code>handle_mod</code>，<code>handle_sys</code>和<code>handle_tlb</code>三种名字呢？原来代码段被命名为<code>handle_\exception</code>了。</p>
<p>​
那这里就类似于传参了，例如下方的<code>BUILD_HANDLER tlb do_tlb_refill</code>，这个异常处理函数自然就叫做<code>handle_tlb</code>了，再看第二个参数作为<code>jal</code>的对象——<code>do_tlb_refill</code>，那是真心熟悉呀🤗，这不是我们在Lab2在tlbex.C写的<strong>快表重填函数</strong>嘛，不出所料<code>do_tlb_mod</code>也在其中。</p>
<h3 id="thinking3.6">🤔Thinking3.6</h3>
<blockquote>
<p>阅读 entry.S、genex.S 和 env_asm.S
这几个文件，并尝试说出时钟中断在哪些时候开启，在哪些时候关闭。</p>
</blockquote>
<p>​
在<code>entry.S</code>中，发生异常后CPU会跳转到函数<code>exc_gen_entry</code>，部分代码与注释如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mfc0    t0, CP0_STATUS  // CP0_STATUS 的内容读取到通用寄存器 t0 中</span><br><span class="line">and     t0, t0, ~(STATUS_UM | STATUS_EXL | STATUS_IE) // 将 t0 中的这三个位强制清零。</span><br><span class="line">mtc0    t0, CP0_STATUS // 通用寄存器 t0 中修改后的值写回到 CP0_STATUS 寄存器中</span><br></pre></td></tr></table></figure>
<p>​ 此前，<code>STATUS_EXL</code>因为异常被置1，
修改<code>CP0_STATUS</code>后<code>STATUS_IE</code>被置0。如此以来，自此到异常处理函数阶段，中断一直保持<strong>禁用状态</strong>。</p>
<p>​
无论是什么异常处理函数，最后应当都跳转到<code>ret_from_exception</code>函数结束异常处理。</p>
<p>​
事实真是如此吗？笔者将在稍后的<strong>🧐迷思三</strong>展开详述，先看<code>ret_from_exception</code>代码段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FEXPORT(ret_from_exception)</span><br><span class="line">	RESTORE_ALL // 恢复至SAVE_ALL之前的值，包括恢复CP0_STATUS寄存器到它在异常发生之前的值</span><br><span class="line">	eret // 将 CP0_EPC 的值恢复到 PC 且 EXL 会被自动设置为 0 </span><br></pre></td></tr></table></figure>
<p>​
此时，因为<code>EXL</code>已然置0，那是否开启中断完全看<code>SAVE_ALL</code>执行前的<code>IE</code>位是否为1，如若是1，中断将变为<strong>开启状态</strong>，反之则保持<strong>关闭状态</strong>。此时应该是<strong>唯一可能开启中断的时机</strong>，其余时间都保持<strong>中断关闭</strong>。</p>
<p>​
这个时候有的朋友就要说了，主播主播🙋‍🤓，<code>handle_int</code>根本就没有执行<code>ret_from_exception</code>！它明明跳转到了<code>Schedule</code>！</p>
<p>​
<strong>还真是，但不完全是🤭。</strong>欲知后事，请看下回。<strong><em>（广告位招租）</em></strong></p>
<h3 id="迷思三-handle_int到底怎么结束的">🧐迷思三
<code>handle_int</code>到底怎么结束的？</h3>
<p>​
看是跳转到了<code>Schedule</code>函数，我们去看看——发现是<em>Exercise
3.12</em>😓</p>
<p>​
但是我们根据指导书关于<strong>进程调度</strong>的介绍，得知这个函数的作用便是用时间片轮转的算法调度进程，最后<strong>运行进程</strong>。因此最后的语句一定是：<code>env_run(e)</code>，其中<code>e</code>是我们调度的进程控制块指针。</p>
<p>​
那我们再回顾一下<code>env_run()</code>，看到最后的<code>env_pop_tf</code>，不妨结合注释看一下它的用途：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LEAF(env_pop_tf)</span><br><span class="line">.set reorder</span><br><span class="line">.set at</span><br><span class="line">	mtc0    a1, CP0_ENTRYHI // 设置 ASID</span><br><span class="line">	move    sp, a0 // 将传入的 Trap Frame 地址 (a0) 设置为当前的栈指针 (sp)</span><br><span class="line">	RESET_KCLOCK</span><br><span class="line">	j       ret_from_exception // 兜兜转转又回到了起点</span><br><span class="line">END(env_pop_tf)</span><br></pre></td></tr></table></figure>
<p>​
因此我们的推测完全正确，<code>handle_int</code>也和其他处理异常函数一样回到了<code>ret_from_exception</code>。</p>
<h3 id="thinking3.7">🤔Thinking3.7</h3>
<blockquote>
<p>阅读相关代码，思考操作系统是怎么根据时钟中断切换进程的。</p>
</blockquote>
<p>​ 根据指导书描述：</p>
<blockquote>
<p>“一旦时钟中断产生，就会触发 4KC 硬件的异常中断处理流程。系统将 PC
指向 0x80000180， 跳转到.text.exc_gen_entry
代码段执行。对于时钟引起的中断，通过.text.exc_gen_entry
代码段的分发，最终会调用 handle_int 函数进行处理。”</p>
</blockquote>
<p>​
值得一提的是，它比我想象中更像<code>entry</code>😮。为什么这么说呢？我觉得它可以称作<strong>COP7与OSLab3的接口，软硬件的交界处</strong>。并不需要什么其他函数去调用唤醒，而是和PC值息息相关。这一刻，感觉唤醒了2024年的记忆，思维在神经元不断链接中形成了闭环。</p>
<p>​
此后的内容便如我们在<strong>迷思三</strong>中的逻辑所展示，函数之间调用关系明确，总结大致如下：</p>
<p>​
<code>exc_gen_entry</code>--&gt;<code>exception_handlers(handle_int)</code>--&gt;<code>schedule</code></p>
<p>​
--&gt;<code>env_run</code>--&gt;<code>env_pop_tf</code>--&gt;<code>ret_from_exception</code></p>
<p>​ 最后在<code>ret_from_exception</code>中，时钟中断得到了恢复。</p>
<h2 id="后记">后记</h2>
<p>​
又到啦最爱的后记环节，感觉自己用心梳理了一天的OSLab3还是蛮有成就感的！😊</p>
<p>​
其实你很难评判一件事情做的是否值得，甚至很难评判它是否有意义。但是我愿意告诉大家我认为它真的很有意义，又是一场伟大的唯心主义的胜利✌。因为我确实比之前总结来说更具自己的思考了，想的东西也很多，和AI坐下来一聊就是一天。给大家截几张和AI的聊天截屏吧📸。</p>
<figure>
<img src="我是神人.png" alt="我是神人" />
<figcaption aria-hidden="true">我是神人</figcaption>
</figure>
<figure>
<img src="我是睡觉大王.png" alt="我是睡觉大王" />
<figcaption aria-hidden="true">我是睡觉大王</figcaption>
</figure>
<figure>
<img src="我与葛米妮.png" alt="我与葛米妮" />
<figcaption aria-hidden="true">我与葛米妮</figcaption>
</figure>
<p>​
现在是晚上<code>22:17</code>，小累小累😌。快要放假了！还有不少事情说是，但是上周都活过来了，这日子是越来越有盼头了😅。</p>
<p>​ 其实想想也是很好笑，人们总说，xx岁是人生最重要的一年。</p>
<p>​
倒也还好，我感觉毕竟人生百八十年呢，每一年都同等重要吧，<strong>没有哪个五年十年能决定我未来走向，也没有哪个一年半载能熄灭我不灭心火</strong>。</p>
<p>​ 很喜欢在这里倾吐一点自己的想法，毕竟是<strong>a private
corner</strong>，让人有种<strong>如释重负</strong>的感觉😌。</p>
<p>​
感谢你看到这里，那我们就要说再见了！亲友们不要再给我打赏了，不然我要撤二维码了哈哈哈😊</p>
<p>​ 言尽于此，回寝歇息。</p>
<blockquote>
<p>别因为短暂的低谷就失去对自己变强的信心，别灰心，万事才刚刚开始啊</p>
</blockquote>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/BUAA-OSLab4学习笔记/" data-toggle="tooltip" data-placement="top" title="BUAA-OSLab4学习笔记">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/OS期中复习总结/" data-toggle="tooltip" data-placement="top" title="OS期中复习总结">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Mon Apr 21 2025 15:29:13 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#buaa-oslab3%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">BUAA-OSLab3实验总结——进程管理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%BE%81%E9%80%94%E4%B8%AD%E7%9A%84%E8%BF%B7%E6%80%9D%E4%B8%8Ethinking"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">征途中的迷思与Thinking</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BF%B7%E6%80%9D%E4%B8%80-%E6%A8%A1%E6%9D%BF%E9%A1%B5%E7%9B%AE%E5%BD%95base_pgdir"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">🧐迷思一
模板页目录(base_pgdir)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%85%88%E9%97%AE%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-nav-number">1.2.1.1.</span> <span class="toc-nav-text">1 先问是什么？</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%8D%E9%97%AE%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E6%A0%B7%E8%AE%BE%E8%AE%A1"><span class="toc-nav-number">1.2.1.2.</span> <span class="toc-nav-text">2 再问为什么（这样设计）？</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%B8%BA%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E9%80%90%E8%A1%8C%E6%B3%A8%E9%87%8A"><span class="toc-nav-number">1.2.1.3.</span> <span class="toc-nav-text">3 为这段代码逐行注释</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BF%B7%E6%80%9D%E4%BA%8C-env_setup_vm-%E5%87%BD%E6%95%B0"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">🧐迷思二 env_setup_vm 函数</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.1"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">🤔Thinking3.1</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.2"><span class="toc-nav-number">1.2.4.</span> <span class="toc-nav-text">🤔Thinking3.2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.3"><span class="toc-nav-number">1.2.5.</span> <span class="toc-nav-text">🤔Thinking3.3</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.4"><span class="toc-nav-number">1.2.6.</span> <span class="toc-nav-text">🤔Thinking3.4</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.5"><span class="toc-nav-number">1.2.7.</span> <span class="toc-nav-text">🤔Thinking3.5</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.6"><span class="toc-nav-number">1.2.8.</span> <span class="toc-nav-text">🤔Thinking3.6</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%BF%B7%E6%80%9D%E4%B8%89-handle_int%E5%88%B0%E5%BA%95%E6%80%8E%E4%B9%88%E7%BB%93%E6%9D%9F%E7%9A%84"><span class="toc-nav-number">1.2.9.</span> <span class="toc-nav-text">🧐迷思三
handle_int到底怎么结束的？</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking3.7"><span class="toc-nav-number">1.2.10.</span> <span class="toc-nav-text">🤔Thinking3.7</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">后记</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#OS" title="OS">OS</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/S7AM1NA">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          S7AM1NA
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://s7am1na.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	</body>
</html>
