<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s a private blog about a human being, welcome to subscribe!"/>
  <meta name="keyword" content="Learning,living,gaming"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://s7am1na.github.io/en/MedMamba 深度解析学习笔记/">
  <title>
    
      MedMamba 深度解析学习笔记 - just a private corner
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">S7的温柔时空角</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: url('/img/header_img/partial_versus_global.png');
      --intro-header-background-image-url-page: url('//img/header_img/partial_versus_global.png');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/partial_versus_global.png');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/partial_versus_global.png');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/partial_versus_global.png'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#MedicalImage" title="MedicalImage">MedicalImage</a>
              
            </div>
            <h1>MedMamba 深度解析学习笔记</h1>
            <h2 class="subheading">架构的“得”与“失”：在性能、效率与模型归纳偏置之间寻找最优解</h2>
            <span class="meta">
              Posted by S7AM1NA on
              2025-09-26
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">14</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">4.2k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
 <!-- MathJax v3（推荐） -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2
id="前言初探医学图像分类一个关于权衡的故事"><strong>前言：初探医学图像分类，一个关于“权衡”的故事</strong></h2>
<p>​ 最近开始在医学图像分类这个方向做了一点点了解，读了学长推荐的
<em>MedMamba</em>
这篇论文，感觉自己所知甚微、所学甚少。话休絮烦，这篇笔记主要记录一下笔者对这篇文章的理解和一些不成熟的思考。</p>
<p>​ 医图领域貌似和CV大环境的情况大差不差，都由两大主流架构主导：CNNs 和
Vision Transformers (ViTs)。</p>
<p>​
二者各有所长，优势互补。先说<strong>CNNs</strong>，通过卷积核的局部感受野和参数共享机制，它在提取图像的<strong>局部纹理</strong>和<strong>边缘特征</strong>上效率极高。但它的全局视野十分受限，很难将图像中相距很远的像素点关联起来，也就是所谓的“长距离依赖”建模能力不足。<strong>而在医学诊断中，这种长距离依赖恰恰至关重要。</strong>
比如在诊断肿瘤是否转移时，医生需要同时观察原发灶和远处的淋巴结；或者在分析神经退行性疾病时，需要捕捉全脑不同区域之间的关联变化。这些都是CNN的天然短板。</p>
<p>​ <strong>Vision Transformers
(ViTs)</strong>则借鉴NLP领域的思想，通过自注意力机制赋予了模型完全意义上的绝对全局视野。但代价是惊人的计算复杂度——与图像块数量的平方
(N^2) 成正比。
这可能意味着模型训练需要极长的周期和顶级的硬件，而推理部署也对医院的设备提出了很高要求。如果一个AI模型需要一台专用的高性能服务器才能运行，那它在基层医院的普及基本无从谈起。</p>
<h2 id="新的挑战者mamba-架构的核心思想"><strong>新的挑战者：Mamba
架构的核心思想</strong></h2>
<p><strong>MedMamba</strong>
的名字里就自带答案。它引入了一个菜菜笔者之前在视觉领域接触不多的新架构：Mamba，它源自于<strong>状态空间模型</strong>
(State Space Model, SSM)，这里不得不放一篇<a
target="_blank" rel="noopener" href="https://blog.csdn.net/v_JULY_v/article/details/134923301">奆佬的超级通透且毫无门槛的博客链接</a>，一方面是知识本身给予我的振奋，另一方面是这位佬讲的是太直观太细致了，持续拜读中🙇‍。</p>
<p>​ Mamba 最吸引笔者的地方在于它对性能和效率的兼顾：</p>
<ul>
<li><strong>能力上</strong>，它通过一种“选择性扫描机制 (Selective
Scan)”实现了对长序列的强大建模能力。这种机制的核心在于它的模型参数是根据输入动态变化的，从而能选择性地决定哪些信息需要记忆，哪些可以遗忘。这在思想上与ViT的注意力机制有异曲同工之妙，都是一种“内容感知”的能力，但是效率更胜一筹。</li>
<li><strong>效率上</strong>，它彻底告别了 O(N^2)
的噩梦，实现了线性的计算复杂度
O(N)。这是通过一种类似RNN的序列扫描方式实现的。</li>
</ul>
<p>这里笔者想对比ViT的自注意力机制比较好理解Mamba的O(N)的优越性。</p>
<p>先聊聊ViT的O(N^2)吧，对于一个输入序列<code>X = &#123;x_1, x_2, ..., x_N&#125;</code>，ViT想要计算出第
t 个输出<code>y_t</code>，思路抽象成公式大概如下： <span
class="math display">\[
y_t = Attention(query_t, {key_1, ..., key_N}, {value_1, ..., value_N})
\]</span>
这里的<code>query_t</code>就源自于<code>x_t</code>，它需要和每个<code>key_*</code>做点积运算（通常？），去分析每个点的与第
t
个点的相关性，因此这一步的复杂度就是O(N)，而N个节点都需要这样的步骤，复杂度自然就是O(N^2)了。这是一种不计代价地“全局广播式”计算，好处就是灵活性被完完全全地实现了，任意两个被分割地patch无论离得多远，都能直接建立联系。</p>
<p>相对地，Mamba的O(N)又是怎么一回事儿呢？它更像是一个高效的流水线处理，每个节点会维护一个隐藏状态<code>h</code><strong>（hidden
state）</strong>，计算第i个输出<code>y_i</code>的时候过程可以简化为：
<span class="math display">\[
\begin{cases}
h_t = f(h_{t-1}, x_t)\\
y_t = g(h_t, x_t)\\
\end{cases}
\]</span> f 是状态更新函数； g
是输出函数。与ViT不同的点就在于这个<code>h_&#123;t-1&#125;</code>，它不仅是上一刻的状态，还是所有历史信息的浓缩。类似于我们熟知的RNN，模型沿着序列从头到尾“扫描”一遍，每个元素只被处理一次，所以总计算量呈线性，即
O(N)。</p>
<p>这个从 O(N^2) 到 O(N) 的飞跃，大抵是 Mamba 能够成为 ViT
高效替代方案的根本原因。然而，这种效率的“得”，背后必然有其“失”。
Mamba的线性扫描，放弃了ViT那种理论上可以一步到位地建立<strong>任意两个Patch</strong>之间联系的完全灵活性。它是一种<strong>结构化的、沿预设路径的信息聚合</strong>。这种用“完全的灵活性”换取“巨大效率”的权衡，是否值得？
在视觉任务中，图像的二维空间结构至关重要，单向的1D扫描似乎并不足够。这也许就引出了
MedMamba
真正的核心设计——它没有直接拥抱纯Mamba，而是选择了一条更精巧的融合之路。</p>
<h2 id="核心探秘拆解-medmamba-的内部架构"><strong>核心探秘：拆解
MedMamba 的内部架构</strong></h2>
<p>如我们上一章所说，1D序列上潜力无限的MedMamba如何将其应用于2D图像，并与CNN的优势相结合，就成了最关键的问题。作者没有粗暴地用
Mamba 替换掉整个网络，而是设计了一个名为 <code>SS-Conv-SSM</code>
的混合模块，这构成了MedMamba的核心架构。</p>
<h3 id="整体蓝图">整体蓝图</h3>
<p>最近写论文画图也画了不少，感觉作者大大的图画的真好看，笔者也想多多学习这种画图基本功，从Github上项目中扒下来放在这里展开讨论一下模型骨架。</p>
<p><img src="MedMambaArch.jpg" /></p>
<p>整体框架设计给人一种成熟且沉稳的感觉。先通过Patch
Embedding将图像分割成块，然后经过四个stage的逐步下采样，应该是通过<strong>Patch
Merging</strong>实现的<del>（笔者认为作者应该笔误写成Path
Merging了）</del>，这个方法对信息的保留度很高，不会像Max
Pooling与Average
Pooling一样损失信息，或者更准确地说是只有”学习式损失“，也就是在最后线性映射将4C维的特征向量压缩到2C维，但是和直接丢弃不同，反向传播会帮助网络来学习到最优的压缩方式。通过这样的方式，模型在<strong>降低空间分辨率</strong>的同时<strong>逐层加深通道数</strong>。这个过程使得模型能够<strong>逐步扩大感受野</strong>，提取从低阶（如边缘、纹理）到高阶（如器官轮廓、病灶形态）不同层次的语义特征。</p>
<p>感觉这样的主流的模型骨架更像是提供了一个公平的范式，便于该模型与其他SOTA堂堂正正地比拼性能，而取胜的关键就在<strong>SS-Conv-SSM</strong>模块当中。</p>
<h3
id="ss-conv-ssm分工与协作的设计艺术"><strong>SS-Conv-SSM：“分工”与“协作”的设计艺术</strong></h3>
<p>其实笔者感觉这种设计艺术有些哲学意味在其中，由图可看出先分道扬镳再终有重逢的意味，双线并行的模型设计在近年来貌似愈发流行，优势互补的设计在这个百花齐放的时代不无道理。</p>
<p><strong>SS-Conv-SSM</strong>的模块内容可以分成以下几个部分：</p>
<ul>
<li><p><strong>Part 1: 分工 (ChannelSplit)</strong>
模块接收到输入特征图后，第一步就是沿着通道维度将其“一分为二”，送入两个并行的分支。作者貌似认为对于医学图像任务，<strong>局部细节的捕捉</strong>和<strong>全局上下文的理解</strong>是同等重要的。
这不禁让人思考，如果这个划分比例成为一个可调的超参数，是否能针对不同特性的数据集（比如某些数据集纹理丰富而有些数据集结构稀疏）进行微调，从而实现更优的性能？但是这又会引入一定的计算量，综合考量下还有待商榷。</p></li>
<li><p><strong>Part 2: 卷积分支 (Conv-Branch)</strong>
其中一半的通道，进入了纯粹的CNN分支。几个3x3的卷积层，专注于它们最擅长的事情：<strong>精细地提取局部空间特征</strong>。这很大程度上保证了模型不会丢失对微小病灶、精细纹理的敏感度。</p></li>
<li><p><strong>Part 3: SSM分支 (SSM-Branch)</strong>
另一半通道，则承担起全局建模的重任。其核心是<strong>SS2D
(2D-Selective-Scan)</strong>
模块。这是从VMamba借鉴来的关键技术，也是Mamba能够在2D图像上工作的根本。它的思路非常巧妙：既然1D扫描是我的强项，那我就从不同方向多扫几遍。具体来说，它通过<strong>四向扫描</strong>（从左上、右下、左下、右上四个方向将2D图像展平为1D序列并分别处理）来近似模拟全局感受野。这样一次处理，每个像素点就都融合了来自整张图各个方向的信息。</p>
<p>这里摆一幅VMamba的官方示意图，膜拜一下，想法简单而效果卓越，笔者也想有这样的巧思！</p>
<p><img src="ss2d.png" /></p>
<p><strong>然而，这种近似并非没有代价。</strong>
四向扫描虽然高效，但它对于图像<strong>边缘或角落</strong>的像素，信息来源会天然不均衡。这是否会影响模型对边缘病灶的判断？这构成了它设计上的又一个“得”与“失”的权衡，效率和全局一致性的取舍。</p></li>
<li><p><strong>Part 4: 协作 (Concatenate &amp; Channel-Shuffle)</strong>
当两个分支各自完成擅长的任务后，它们的输出被重新拼接在一起。如果仅仅是拼接，那两部分信息依然是割裂的。作者在这里加入了一个非常精妙的操作——<strong>通道重排
(Channel-Shuffle)</strong>。这个操作就像洗牌一样，将来自卷积分支和SSM分支的通道彻底打乱混合。它确保了在进入<strong>下一个</strong>SS-Conv-SSM模块时，被切分的两半特征都同时包含了上一层提取到的局部信息和全局信息。这极大地促进了两种不同尺度特征的深度融合。</p>
<p>当然，我们也可以考虑更复杂的融合方式，比如可以引入一个tiny的注意力模块，但是相比Shuffle这个零计算开销的设计来说，会增加一些计算负担，这里作者对极致效率的追求也就可见一斑了。</p></li>
</ul>
<p>通过这样一套<strong>“分工-专精-协作-融合”</strong>的流程，SS-Conv-SSM模块在一个统一的单元内，优雅地实现了局部特征与全局依赖的并行捕捉与深度融合，构成了MedMamba强大性能和高效率的核心。</p>
<h3
id="实验验证数据背后的铁证如山"><strong>实验验证：数据背后的铁证如山</strong></h3>
<ol type="1">
<li><p><strong>全面的基准测试奠定可信度</strong></p>
<p>在深入具体数据之前，笔者先关注了其实验设置的广度。论文中提到，他们在
<strong>16个不同的公开和私有数据集</strong> 上对 MedMamba
进行了评估，其中包含了学长要求的公开数据集共计14个，这些数据集涵盖了<strong>10种不同的影像模态</strong>（如超声、X光、CT、内窥镜等）。这一点非常重要，因为它证明了
MedMamba
不是只能在特定类型数据上表现良好，其架构设计具有很好的<strong>通用性
(Generality)</strong>。</p></li>
<li><p><strong>性能与效率的全面胜利</strong></p>
<p><strong>(Accuracy vs. FLOPs)</strong>
这张图，笔者认为是整篇论文实验结果中最核心、最直观的展示。它将不同模型放在一个二维坐标系中，X轴代表计算量(FLOPs)，Y轴代表平均准确率(OA)，圆圈大小代表参数量。</p>
<p><img src="Performance.png" /></p>
<p>我们评估一个模型的“性价比”，就是要看它是否能处在这个坐标系的<strong>左上角区域</strong>——即以更低的计算成本，获得更高的性能。</p>
<p>从图中可以清晰地看到，无论是 MedMamba-T, S, 还是 B，绿色的 MedMamba
家族模型点，都稳定地出现在了其同级别对手（如 Swin-T/S/B,
ConvNeXt-T/S/B）的<strong>左上方</strong>。这完美地、可视化地印证了我们之前的分析：<strong>SS-Conv-SSM
混合架构确实实现了更优的性能-效率权衡</strong>。它不仅在大多数任务上取得了SOTA的性能，而且是以显著更低的计算和参数开销实现的。</p></li>
<li><p><strong>洞悉模型的真实想法</strong></p>
<p>除了“跑分”很高，一个好的模型还应该让我们相信它的决策过程是合理的。</p>
<ul>
<li><strong>它在看哪里？:</strong>
论文展示的Grad-CAM热力图，让我们得以一窥模型的“注意力”。在不同的数据集上，高亮的热力图区域都准确地覆盖了图像中的病灶区域，而不是一些无关的背景。这在很大程度上说明，MedMamba学到的是<strong>有意义的、符合医学逻辑的特征</strong>，这增强了模型的可解释性和在临床应用中的可信度。</li>
</ul>
<p><img src="Grad-CAM.png" /></p>
<ul>
<li><strong>它学到了什么？:</strong>
t-SNE提供了一个更深层次的视角。通过将高维特征降维可视化，我们可以直观地看到模型对不同类别样本的区分能力。Figure
6的对比展示出了MedMamba的卓越：相比于Swin-S和ConvNeXt-S混杂、重叠的特征点簇，<strong>MedMamba-S学习到的特征表示显然具有更强的区分度</strong>，不同类别的样本被清晰地分离开来。这从根本上解释了它为何能取得更高的分类精度。</li>
</ul>
<p><img src="t-SNE.png" /></p></li>
<li><p><strong>再思考</strong></p>
<p>这次精读也让我对几个关键评价指标有了新的认识。尤其是在类别通常不均衡的医疗数据中，相比于最直观的<strong>OA
(Overall
Accuracy)</strong>，<strong>F1-Score</strong>以及不依赖特定阈值、能衡量模型整体分类潜力的<strong>AUC</strong>，都是更可靠、更全面的评估标准。MedMamba在这些关键指标上的全面领先，进一步巩固了其SOTA的地位。<del><em>(同时也有一些疑惑，面对数据极不平衡的医图数据集，为什么大家在比较性能的时候还会考虑OA呢，这难道不是几乎没有参考价值吗)</em></del></p></li>
</ol>
<h2 id="总结与展望有何收获"><strong>总结与展望：有何收获？</strong></h2>
<p>又到了一篇博客的尾声，笔者想要沉淀一下本次论文阅读的收获，以记录自己成长的足迹。我对以下问题有了新的认识与思考：</p>
<ul>
<li><strong>架构设计的艺术哲学：</strong>
仿佛这些年来底层算子的创新迭代日益趋缓了，算法的上层建筑在快速发展，将已有的模块利用优势互补、扬长避短等思想高效融合起来未尝不是一种解决特定场景任务的好方法。但是不同于某些同行在模型中使用一些即插即用的模块，笔者认为这些融合的结果必须是巧妙的、有据可依的，而不是强行缝合得到的怪物，此二者显然有天差地别。</li>
<li><strong>效率与性能的再平衡：</strong>
医图分类是我接触过最接近于现实的CV领域了，确实不能像纸上谈兵那样，为了追求微乎其微的性能提升而不计成本地堆叠计算量。MedMamba也向我们成功证明，一个足够强大的近似全局建模不简单比ViT差，实际应用价值也远超ViT等各种大型模型。</li>
<li><strong>“归纳偏置”的价值：</strong>
这篇论文也让笔者重新思考了“归纳偏置”的角色。ViT的成功曾让我们一度迷恋于“让模型从零开始学习一切”的暴力美学。这也让笔者想起曾经在分析信号时做特征工程与否的抉择，原则上将原始数据喂给Transformer便是最先进的选择，但是我们用前辈们的先验知识做特征工程喂给简单的LSTM性能一样不差。同样MedMamba通过重新拥抱CNN的<strong>“局部性”和“平移不变性”</strong>偏置，向我们证明了：为特定任务注入合理的先验知识，不见得一定是原始的、费力而不讨喜的工作，还有可能是一种融合先验与未知的明智选择</li>
</ul>
<p><strong><em>算力的洪流之下，人类的智慧与巧思，依然是点亮前路最璀璨的星火。</em></strong></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          
          <li class="next">
            <a href="/en/星辰为图，时空为序：我如何从零构建一个用于GNSS泛化挑战的Graph-Transformer架构/" data-toggle="tooltip" data-placement="top" title="星辰为图，时空为序：我如何从零构建一个用于GNSS泛化挑战的Graph Transformer架构">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Fri Sep 26 2025 13:26:33 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80%E5%88%9D%E6%8E%A2%E5%8C%BB%E5%AD%A6%E5%9B%BE%E5%83%8F%E5%88%86%E7%B1%BB%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%9D%83%E8%A1%A1%E7%9A%84%E6%95%85%E4%BA%8B"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">前言：初探医学图像分类，一个关于“权衡”的故事</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%96%B0%E7%9A%84%E6%8C%91%E6%88%98%E8%80%85mamba-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%A0%B8%E5%BF%83%E6%80%9D%E6%83%B3"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">新的挑战者：Mamba
架构的核心思想</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%A0%B8%E5%BF%83%E6%8E%A2%E7%A7%98%E6%8B%86%E8%A7%A3-medmamba-%E7%9A%84%E5%86%85%E9%83%A8%E6%9E%B6%E6%9E%84"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">核心探秘：拆解
MedMamba 的内部架构</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%95%B4%E4%BD%93%E8%93%9D%E5%9B%BE"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">整体蓝图</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ss-conv-ssm%E5%88%86%E5%B7%A5%E4%B8%8E%E5%8D%8F%E4%BD%9C%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%89%BA%E6%9C%AF"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">SS-Conv-SSM：“分工”与“协作”的设计艺术</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%9E%E9%AA%8C%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE%E8%83%8C%E5%90%8E%E7%9A%84%E9%93%81%E8%AF%81%E5%A6%82%E5%B1%B1"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">实验验证：数据背后的铁证如山</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B%E6%9C%89%E4%BD%95%E6%94%B6%E8%8E%B7"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">总结与展望：有何收获？</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#MedicalImage" title="MedicalImage">MedicalImage</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/S7AM1NA">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          S7AM1NA
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://s7am1na.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
