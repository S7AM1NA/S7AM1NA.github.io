<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s a private blog about a human being, welcome to subscribe!"/>
  <meta name="keyword" content="Learning,living,gaming"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://s7am1na.github.io/en/BUAA-OSLab4学习笔记/">
  <title>
    
      BUAA-OSLab4学习笔记 - just a private corner
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">S7的温柔时空角</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: url('/img/header_img/ghost_blade6.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/ghost_blade6.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/ghost_blade6.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/ghost_blade6.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/ghost_blade6.jpg'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#OS" title="OS">OS</a>
              
            </div>
            <h1>BUAA-OSLab4学习笔记</h1>
            <h2 class="subheading">疑似放假博主陷入内核态学习OS</h2>
            <span class="meta">
              Posted by S7AM1NA on
              2025-05-02
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">14</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">4k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
 <!-- MathJax v3（推荐） -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="buaa-oslab4学习笔记">BUAA-OSLab4学习笔记</h1>
<h2 id="前言">前言</h2>
<p>​
本系列正式改名为<strong>学习笔记</strong>！考虑到过程性博客的内容与标题中<strong>“总结”</strong>字眼实属不符，记录学习过程的所思所想才是真正的核心内容~✍</p>
<p>​
本周是劳动节放假噢！<strong>祝所有家人朋友节日快乐！</strong>🎉感觉<strong>宅属性</strong>大爆发了，没有人约出去玩的话感觉不如呆在学校里（瘫瘫），虽然没出去玩，但是在北京周围和朋友吃了很多好吃的、玩了好多好玩的，玩其实也是蛮累的！</p>
<p>​
坐在图书馆里静静回想平日的繁忙，再体会体会假期的闲暇，时光如风中落叶簌簌地落入心潭，每次回忆都是我们从潭中拾起那片片落叶，摩挲回味一番，便归还心底。</p>
<p>​
每当脑子漫无目的地联想的时候，我感觉自己像得了阿尔兹海默症，我好像在哪里见过这一幕？心中萌生出一种垂垂老矣的忧郁感——</p>
<p>​ 罢啦，不记得了。</p>
<blockquote>
<p>I think I've seem this film before.</p>
<p>其实这一幕我已然熟稔。</p>
</blockquote>
<h2 id="思考题与我的迷思">思考题与我的迷思</h2>
<h3 id="thinking4.1">Thinking4.1</h3>
<blockquote>
<p>思考并回答下面的问题：</p>
<p>• 内核在保存现场的时候是如何避免破坏通用寄存器的？</p>
<p>• 系统陷入内核调用后可以直接从当时的 <span
class="math inline">\(a0-\)</span>a3 参数寄存器中得到用户调用 msyscall
留下的信息吗？</p>
<p>• 我们是怎么做到让 sys 开头的函数“认为”我们提供了和用户调用 msyscall
时同样 的参数的？</p>
<p>• 内核处理系统调用的过程对 Trapframe
做了哪些更改？这种修改对应的用户态的变 化是什么？</p>
</blockquote>
<ul>
<li>当发生异常（比如中断、系统调用或错误）时，CPU
会跳转到内核的异常处理程序。这个处理程序需要完整地保存当前被打断的程序（无论是用户程序还是内核自身）的状态，以便后续能够恢复执行。这个状态包括了所有的通用寄存器（$0
到 $31）、特殊寄存器（如 HI/LO）以及状态寄存器（如 CP0_STATUS,
CP0_CAUSE, CP0_EPC
等）。但是实际上，执行<strong>保存</strong>操作本身也需要使用<strong>寄存器</strong>。这就带来了一个矛盾：<strong>如何使用通用寄存器来保存它们自己原来的值，而不在保存完成前就覆盖掉这些值？</strong></li>
</ul>
<p>​
我们在<code>./include/stackframe.h</code>中可以读到<code>SAVE_ALL</code>的宏函数源码，其处理关键如下：</p>
<ol type="1">
<li><p><strong>使用内核保留的“暂存”寄存器 (<span
class="math inline">\(k0,\)</span>k1)：</strong></p>
<p>他们本就是内核临时寄存器，对于<code>mfc0    k0, CP0_STATUS</code>这种覆盖操作而言是无感的。此后，宏会通过<code>sw $26, TF_REG26(sp)</code>指令，将
$k0 <strong>在异常发生时的原始值</strong>也保存到栈帧里。</p></li>
<li><p><strong>特殊处理栈指针($sp, $29):</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mfc0    k0, CP0_STATUS</span><br><span class="line">andi    k0, STATUS_UM</span><br><span class="line">beqz    k0, 1f # 1是label f是后缀,意为forward,即search forward for &quot;1&quot;</span><br><span class="line">move    k0, sp</span><br><span class="line">/*</span><br><span class="line">* If STATUS_UM is not set, the exception was triggered in kernel mode.</span><br><span class="line">* $sp is already a kernel stack pointer, we don&#x27;t need to set it again.</span><br><span class="line">*/</span><br><span class="line">li      sp, KSTACKTOP</span><br></pre></td></tr></table></figure>
<p>如代码所示，根据异常发生在不同的模式下，判断是否要提前保留栈指针，因为需要用它来定位保存所有其他寄存器的内存区域，也就是我们在MIPS中看到的<code>Trap Frame</code>陷阱帧。</p></li>
</ol>
<ul>
<li>可以。因为内核在陷入内核、保存现场的过程中，寄存器
<code>a0-a3</code> 中的值都没有被破坏。</li>
<li>用户在调用 msyscall 时，传入的参数会被保存在 a0-a3
寄存器和堆栈中。当陷入内核时，a0-a3
寄存器不会被破坏，并且会将用户栈中的相应参数复制取出到内核现场寄存器与内核栈中。因此，<code>sys_*</code>
函数可以从寄存器和用户栈处获得用户调用 msyscall 时传入的参数值。</li>
<li>首先，将栈中存储的EPC寄存器值增加4，这是因为系统调用后，将会返回下一条指令；然后，将返回值存入$v0，返回用户态后可以获取调用后的返回值。</li>
</ul>
<h3 id="thinking4.2">Thinking4.2</h3>
<blockquote>
<p>思考 envid2env 函数: 为什么 envid2env 中需要判断 e-&gt;env_id !=
envid 的情况？如果没有这步判断会发生什么情况？</p>
</blockquote>
<p>​
在我们使用<code>envid</code>获取对应的进程控制块时，只取出了后10位作为数组下标，具体实现在<code>./include/env.h</code>中，相关代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define LOG2NENV 10</span><br><span class="line">#define NENV (1 &lt;&lt; LOG2NENV)</span><br><span class="line">#define ENVX(envid) ((envid) &amp; (NENV - 1))</span><br></pre></td></tr></table></figure>
<p>​
因此我们要再一次使用语句<code>e-&gt;env_id != envid</code>判断二者是否完全相等，只有完全相等才能确定找到正确的控制块，否则有可能取到错误的、甚至本该销毁的控制块。</p>
<h3 id="wondering1">Wondering1</h3>
<p>​
在第二个测试点中，<code>syscall_mem_map2</code>这个点一直无法通过，经过笔者的反复printk调试发现，在进入<code>sys_mem_map</code>前，<code>dstva</code>就发生了一些奇妙的变化。后来想明白了，是<code>do_syscall</code>函数<strong>传参</strong>出现了问题。</p>
<p>​
我之所以没发现，是因为我以为这个点是直接调用的<code>sys_mem_map</code>函数，但是仔细看了好久才发现原来不是，<code>syscall_mem_map</code>先调用<code>msyscall</code>之后才进入<code>sys_mem_map</code>函数。根据参数位置不难定位的可疑代码段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u_int arg4, arg5;</span><br><span class="line">	<span class="comment">/* Exercise 4.2: Your code here. (3/4) */</span></span><br><span class="line">	arg4 = tf-&gt;regs[<span class="number">29</span>] + <span class="number">16</span>;</span><br><span class="line">	arg5 = tf-&gt;regs[<span class="number">29</span>] + <span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>显然这种写法把参数的地址取了出来...那进行类型转换后解引用便是正确的写法了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u_int arg4, arg5;</span><br><span class="line">	<span class="comment">/* Exercise 4.2: Your code here. (3/4) */</span></span><br><span class="line">	arg4 = *((u_int *)(tf-&gt;regs[<span class="number">29</span>] + <span class="number">16</span>));</span><br><span class="line">	arg5 = *((u_int *)(tf-&gt;regs[<span class="number">29</span>] + <span class="number">20</span>));</span><br></pre></td></tr></table></figure>
<h3 id="thinking4.3">Thinking4.3</h3>
<blockquote>
<p>思考下面的问题，并对这个问题谈谈你的理解：请回顾 kern/env.c 文件 中
mkenvid() 函数的实现，该函数不会返回 0，请结合系统调用和 IPC
部分的实现与 envid2env() 函数的行为进行解释。</p>
</blockquote>
<p>​ 感觉像是伏笔。</p>
<p>​
我们回过头来看，<code>envid2env</code>如果接收到<code>mkenvid</code>返回的0值会如何。先看<code>envid2env</code>相关的代码段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Exercise 4.3: Your code here. (1/2) */</span></span><br><span class="line">	<span class="keyword">if</span> (envid == <span class="number">0</span>) &#123;</span><br><span class="line">		e = curenv;</span><br><span class="line">		 *penv = curenv;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		e = &amp;envs[ENVX(envid)];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​
大意就是，如果<code>envid</code>的值确实为0，那就将*penv设置成当前的curenv，这是一个特殊情况处理。而我们在<code>sys_ipc_try_send</code>中调用了<code>envid2env</code>，那意味着如果的确存在<code>envid == 0</code>的进程，那他将永远无法正常通信。</p>
<h3 id="thinking4.4">Thinking4.4</h3>
<blockquote>
<p>Thinking 4.4 关于 fork 函数的两个返回值，下面说法正确的是：</p>
<p>A、fork 在父进程中被调用两次，产生两个返回值</p>
<p>B、fork 在两个进程中分别被调用一次，产生两个不同的返回值</p>
<p>C、fork 只在父进程中被调用了一次，在两个进程中各产生一个返回值</p>
<p>D、fork 只在子进程中被调用了一次，在两个进程中各产生一个返回值</p>
</blockquote>
<p>答案是C；根据我们做的实验得到的信息，也是指导书的提示，我们可知：</p>
<blockquote>
<p>• fork 之前只有父进程存在。</p>
<p>• fork 之后，父子进程同时开始执行 fork 之后的代码段。</p>
<p>• fork 在不同的进程中返回值不一样，在子进程中返回值为
0，在父进程中返回值不为 0， 而为子进程的 pid（Linux 中进程专属的
id，类似于 MOS 中的 envid）。</p>
</blockquote>
<p>也就是说子进程是由fork产生的，自然不可能被子进程调用，所以fork只在父进程被调用了一次，并且在两个进程中各自返回了一个值。</p>
<h3 id="thinking4.5">Thinking4.5</h3>
<blockquote>
<p>我们并不应该对所有的用户空间页都使用 duppage 进行映射。那么究竟哪
些用户空间页应该映射，哪些不应该呢？请结合 kern/env.c 中 env_init
函数进行的页 面映射、include/mmu.h
里的内存布局图以及本章的后续描述进行思考。</p>
</blockquote>
<p>​ 在 <code>0 ~ UTOP</code> 范围的内存需要使用 duppage 进行映射;</p>
<p>​ 先回顾一下<code>mmu.h</code>中layout：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">o      ULIM     -----&gt; +----------------------------+------------0x8000 0000-------</span><br><span class="line">o                      |         User VPT           |     PDMAP                /|\</span><br><span class="line">o      UVPT     -----&gt; +----------------------------+------------0x7fc0 0000    |</span><br><span class="line">o                      |           pages            |     PDMAP                 |</span><br><span class="line">o      UPAGES   -----&gt; +----------------------------+------------0x7f80 0000    |</span><br><span class="line">o                      |           envs             |     PDMAP                 |</span><br><span class="line">o  UTOP,UENVS   -----&gt; +----------------------------+------------0x7f40 0000    |</span><br><span class="line">o  UXSTACKTOP -/       |     user exception stack   |     PTMAP                 |</span><br><span class="line">o                      +----------------------------+------------0x7f3f f000    |</span><br><span class="line">o                      |                            |     PTMAP                 |</span><br><span class="line">o      USTACKTOP ----&gt; +----------------------------+------------0x7f3f e000    |</span><br><span class="line">o                      |     normal user stack      |     PTMAP                 |</span><br><span class="line">o                      +----------------------------+------------0x7f3f d000    |</span><br><span class="line">a                      |                            |                           |</span><br><span class="line">a                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                           |</span><br><span class="line">a                      .                            .                           |</span><br><span class="line">a                      .                            .                         kuseg</span><br><span class="line">a                      .                            .                           |</span><br><span class="line">a                      |~~~~~~~~~~~~~~~~~~~~~~~~~~~~|                           |</span><br><span class="line">a                      |                            |                           |</span><br><span class="line">o       UTEXT   -----&gt; +----------------------------+------------0x0040 0000    |</span><br><span class="line">o                      |      reserved for COW      |     PTMAP                 |</span><br><span class="line">o       UCOW    -----&gt; +----------------------------+------------0x003f f000    |</span><br><span class="line">o                      |   reversed for temporary   |     PTMAP                 |</span><br><span class="line">o       UTEMP   -----&gt; +----------------------------+------------0x003f e000    |</span><br><span class="line">o                      |       invalid memory       |                          \|/</span><br><span class="line">a     0 ------------&gt;  +----------------------------+ ----------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>​
其中我们知道，<code>UTOP</code>也就是<code>0x7f40 0000</code>以上的地址中存放的内存与页表是全体进程共享的，且用户进程无法访问，自然不需要<code>duppage</code>做映射了。</p>
<p>​
而<code>USTACKTOP</code>到<code>UTOP</code>之间的地址中，<code>layout</code>把它描述为<strong><code>User Exception Stack</code></strong>，也就是<strong>用户异常栈</strong>，用于处理页写入异常，包含了一段缓冲区地址空间。在往年的学姐博客<a
target="_blank" rel="noopener" href="https://yanna-zy.github.io/2023/05/15/BUAA-OS-4/">BUAA-OS-lab4 |
YannaのBlog</a>中提到以下观点：</p>
<blockquote>
<p>USTACKTOP 到 UTOP 之间的 user exception stack
是用来进行页写入异常的，不会在处理COW异常时调用 fork() ,所以 user
exception stack 这一页不需要共享；</p>
<p>USTACKTOP 到 UTOP 之间的 invalid memory
是为处理页写入异常时做缓冲区用的，所以同理也不需要共享；</p>
</blockquote>
<p>​
感觉这样的做法像是一种特定的性能优化，但这样对整个系统的可扩展性和一致性造成了一定的破坏，考虑到<strong>用户异常栈</strong>其实总计不会有很多页，所以笔者更倾向于也将<strong>用户异常栈</strong>进行映射。</p>
<h3 id="thinking4.6">Thinking4.6</h3>
<blockquote>
<p>在遍历地址空间存取页表项时你需要使用到 vpd 和 vpt 这两个指针，请参考
user/include/lib.h 中的相关定义，思考并回答这几个问题：</p>
<p>• vpt 和 vpd 的作用是什么？怎样使用它们？</p>
<p>• 从实现的角度谈一下为什么进程能够通过这种方式来存取自身的页表？</p>
<p>• 它们是如何体现自映射设计的？</p>
<p>• 进程能够通过这种方式来修改自己的页表项吗？</p>
</blockquote>
<p>​ 定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define vpt ((const volatile Pte *)UVPT)</span><br><span class="line">#define vpd ((const volatile Pde *)(UVPT + (PDX(UVPT) &lt;&lt; PGSHIFT)))</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>作用：</strong></p>
<ul>
<li><strong>vpd</strong>：vpd 是一个指向当前进程<strong>页目录 (Page
Directory)</strong>
的虚拟地址指针。它允许用户程序以<strong>只读</strong>方式访问其自身页目录中的每一个页目录项
(PDE - Page Directory Entry)。</li>
<li><strong>vpt</strong>：vpt
是一个指向一个巨大的虚拟内存区域的指针，这个区域映射了当前进程所有（或大部分）<strong>页表
(Page
Tables)</strong>。它允许用户程序以<strong>只读</strong>方式访问其自身页表中的每一个页表项
(PTE - Page Table Entry)。</li>
</ul></li>
<li><p><strong>使用 vpd</strong>：</p>
<ul>
<li>vpd 可以被当作一个 Pde 类型的数组（或指针）来使用。</li>
<li>要访问页目录中的第 i 个页目录项，可以使用 vpd[i]。</li>
<li>通常，i 是通过从虚拟地址中提取页目录索引得到的，即 PDX(va)。</li>
</ul></li>
<li><p><strong>使用 vpt</strong>：</p>
<ul>
<li><p>vpt 可以被当作一个巨大的 Pte
类型的数组（或指针）来使用。</p></li>
<li><p>要访问某个虚拟地址对应的页表项，需要进行稍微复杂一点的计算，因为
vpt
线性地映射了所有的页表。你需要知道这个虚拟地址属于哪个页表（由其页目录索引确定），以及它在该页表中的索引。</p></li>
<li><p><strong>遍历地址空间</strong>：</p>
<ul>
<li>通过虚拟页号 vpn 从 0 到 VPN(UTOP - 1) 循环，直接使用
vpt[vpn]来访问对应的页表项，并通过 vpd[PDX(vpn &lt;&lt; PGSHIFT)]
来检查相关的页目录项。</li>
</ul></li>
</ul></li>
<li><p>关于<strong>自映射</strong>：</p>
<ul>
<li><strong>自映射的核心</strong>：自映射指的是页表结构中的一部分（一个页目录项）被用来映射页表结构自身（通常是页目录）。</li>
<li>自映射设计使得<strong>页表结构本身也成为了可以通过虚拟地址访问的对象</strong>，而
vpd 和 vpt 就是访问这些对象的便捷指针。</li>
</ul></li>
<li><p><strong>进程无权修改页表项。</strong></p>
<ul>
<li><pre class="pseudocode"><code>// 摘自page_insert函数
*pte = page2pa(pp) | perm | PTE_C_CACHEABLE | PTE_V;</code></pre></li>
<li>根据<code>page_insert</code>函数中的代码以及其参数<code>perm = PTE_G</code>，我们可以确定，每个页表项的权限位应该是：<strong><code>PTE_G | PTE_C_CACHEABLE | PTE_V</code></strong>。故无权修改。</li>
</ul></li>
</ul>
<h3 id="thinking4.7">Thinking4.7</h3>
<blockquote>
<p>在 do_tlb_mod 函数中，你可能注意到了一个向异常处理栈复制 Trapframe
运行现场的过程，请思考并回答这几个问题：</p>
<p>•
这里实现了一个支持类似于“异常重入”的机制，而在什么时候会出现这种“异常重入”？</p>
<p>• 内核为什么需要将异常的现场 Trapframe 复制到用户空间？</p>
</blockquote>
<ol type="1">
<li><p>“异常重入”的时机：</p>
<p>当一个用户态的异常处理程序（比如由 env_user_tlb_mod_entry
指向的函数）在执行过程中，<strong>它自己又触发了一个需要内核介入的异常</strong>，这时就可以看作是一种“异常重入”的场景。但是要明确这里的“异常重入”与内核态自身的异常重入（即内核代码执行时又发生异常）可能有所不同。我们这里讨论的应该是<strong>用户态异常处理过程中的进一步异常</strong>，或者说<strong>嵌套的用户态异常处理</strong>。</p></li>
<li><p>为什么需要复制<code>Trapframe</code>？</p>
<ul>
<li>向用户态处理程序提供<strong>异常上下文信息</strong>。</li>
<li>隔离内核数据与用户逻辑，防止用户态代码直接访问内核栈。</li>
<li>支持用户态处理程序时修改并恢复上下文信息。</li>
</ul></li>
</ol>
<h3 id="wondering2">Wondering2</h3>
<blockquote>
<p><code>cow_entry</code>到底做了什么？它在整个fork中又是什么角色？</p>
</blockquote>
<p>​ cow_entry 是一个<strong>用户态函数</strong>，作为 fork
后写时复制机制的一部分。当进程尝试写入一个被 fork
标记为COW（只读）的页面时，它被内核通过异常处理机制调用。它的核心任务是<strong>响应这个写保护错误，通过系统调用请求内核分配新页面、复制数据、并以可写权限重新映射出错的虚拟地址，从而完成页面的“写时复制”，最后恢复到原先失败的写操作处继续执行。</strong>
它正是保证COW语义正确实现的关键执行单元。</p>
<h3 id="thinking4.8">Thinking4.8</h3>
<blockquote>
<p>在用户态处理页写入异常，相比于在内核态处理有什么优势？</p>
</blockquote>
<ul>
<li>首先，正如指导书所说，它减少了内核的复杂性，符合微内核的设计理念，将功能实现留在用户空间中。</li>
<li>其次，处理方法具有更高的灵活性与可定制性，能够快速的进行实验。</li>
</ul>
<h3 id="thinking4.9">Thinking4.9</h3>
<blockquote>
<p>请思考并回答以下几个问题：</p>
<p>• 为什么需要将 syscall_set_tlb_mod_entry 的调用放置在 syscall_exofork
之前？</p>
<p>• 如果放置在写时复制保护机制完成之后会有怎样的效果？</p>
</blockquote>
<p>​
因为在<code>syscall_exofork</code>中，我们有可能就会读写父进程的相关页，要在此之前处理好父进程的页写入异常。</p>
<p>​
父进程在调用写时复制保护机制可能会引发缺页异常，而异常处理未设置好，则不能正常处理。</p>
<h2 id="实验体会">实验体会</h2>
<p>​
感觉Lab4的内容相对之前来说比较规整，更加清晰地展现在了我们面前，可能也是因为逐渐接近了操作系统比较上层的内容了（？），总之做起来有一种很神清气爽的感觉，但是有些内容还是基于前面的Lab，在做课上的时候，我感觉对前面的内容以及C语言基础不熟悉成为了我最大败笔。希望以后有所精进，有所收获。😊</p>
<h2 id="后记">后记</h2>
<p>​
五一过后的第一周嘛，刚准备放松放松就要搞冯如杯入围答辩了？疑似有点太紧凑了。</p>
<p>​
话说怎么莫名其妙就入围了，“答辩”也能入围答辩吗？🤔既然如此，好好准备答辩，编一编内容，在大佬云集的入围答辩中跳好最后一舞吧💃</p>
<p>​ 着急赶PPT，我们下期见！👋</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/en/20250511/" data-toggle="tooltip" data-placement="top" title="20250511">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/en/BUAA-OSLab3实验总结/" data-toggle="tooltip" data-placement="top" title="BUAA-OSLab3实验总结">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Fri May 02 2025 15:36:53 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#buaa-oslab4%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">BUAA-OSLab4学习笔记</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E6%80%9D%E8%80%83%E9%A2%98%E4%B8%8E%E6%88%91%E7%9A%84%E8%BF%B7%E6%80%9D"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">思考题与我的迷思</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.1"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">Thinking4.1</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.2"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">Thinking4.2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#wondering1"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">Wondering1</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.3"><span class="toc-nav-number">1.2.4.</span> <span class="toc-nav-text">Thinking4.3</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.4"><span class="toc-nav-number">1.2.5.</span> <span class="toc-nav-text">Thinking4.4</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.5"><span class="toc-nav-number">1.2.6.</span> <span class="toc-nav-text">Thinking4.5</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.6"><span class="toc-nav-number">1.2.7.</span> <span class="toc-nav-text">Thinking4.6</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.7"><span class="toc-nav-number">1.2.8.</span> <span class="toc-nav-text">Thinking4.7</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#wondering2"><span class="toc-nav-number">1.2.9.</span> <span class="toc-nav-text">Wondering2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.8"><span class="toc-nav-number">1.2.10.</span> <span class="toc-nav-text">Thinking4.8</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#thinking4.9"><span class="toc-nav-number">1.2.11.</span> <span class="toc-nav-text">Thinking4.9</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%AE%9E%E9%AA%8C%E4%BD%93%E4%BC%9A"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">实验体会</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">后记</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#OS" title="OS">OS</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/S7AM1NA">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          S7AM1NA
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://s7am1na.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	</body>
</html>
