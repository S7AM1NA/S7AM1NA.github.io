<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s a private blog about a human being, welcome to subscribe!"/>
  <meta name="keyword" content="Learning,living,gaming"/>
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://s7am1na.github.io/en/BUAA-OO2025第二单元总结/">
  <title>
    
      BUAA-OO2025第二单元总结 - just a private corner
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">S7的温柔时空角</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
          
          
          
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: url('/img/header_img/ghost_knife3.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/ghost_knife3.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/categories_bg.WebP');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/ghost_knife3.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/ghost_knife3.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/ghost_knife3.jpg'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#OO" title="OO">OO</a>
              
            </div>
            <h1>BUAA-OO2025第二单元总结</h1>
            <h2 class="subheading">Do you want to take a lift in MY ELEVATOR?😈</h2>
            <span class="meta">
              Posted by S7AM1NA on
              2025-04-19
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">13</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.9k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
 <!-- MathJax v3（推荐） -->
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="buaa_oo2025第二单元总结">BUAA_OO2025第二单元总结</h1>
<blockquote>
<p>疾风知劲草，路遥知马力。</p>
</blockquote>
<h2 id="前言">前言</h2>
<p>​ 起风了。</p>
<p>​
上个周末的北京起风了。官方提前预警大狂风，周五晚上不信邪的我和🐝想尝尝风的咸淡。嗯，俩人回寝路上吃了俩嘴沙子。</p>
<p>​ 怎么评价呢？我觉得不算咸口😋，嗓子痒痒的。</p>
<p>​
我还是蛮喜欢在大风中漫步的感觉的😊，感觉是为数不多和大自然较劲的机会，当然最好不要让我吃到沙子。<strong>疾风知劲草</strong>，前人道理说的不错，但是我这周迎来了自己的<strong>【超级疾风】</strong>，期中考试、校园论文截稿、会议论文截稿。笔者想想都头皮发麻，今天好好睡了一个懒觉，也是因为实在起不来了😴。在这里写博客，也算许下一个简单的愿望，希望我的家人、朋友和自己都能做自己生命风暴中的<strong>【劲草】</strong>。我们不一定终于伟大，但一定忠于自己，任尔东西南北疾风暴风大狂风，<strong>当人生千磨万击，请诸君务必坚劲</strong>。</p>
<p>​
下面请看正文，为大家带来<strong>多线程电梯</strong>的OO单元总结。</p>
<h2 id="壹-同步块与锁">壹 同步块与锁</h2>
<h3 id="同步块的设置">1 同步块的设置</h3>
<p>​ 同步块是 Java
中实现线程同步的一种基本方式。它的核心思想是：<strong>为一段代码指定一个“锁对象”，任何线程想要执行这段代码，必须先获得这个锁对象的所有权（Monitor
Lock）。一次只有一个线程能持有该锁，其他试图获取锁的线程会被阻塞，直到持有锁的线程执行完毕并释放锁。</strong></p>
<p>​ 代码语法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (lockObject) &#123;</span><br><span class="line">    <span class="comment">// 需要同步的代码块 (临界区 - Critical Section)</span></span><br><span class="line">    <span class="comment">// 这部分代码在同一时间只允许一个线程执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​
<code>lockObject</code>（锁对象）的选择直接决定了<strong>同步的范围和行为</strong>。常见的选择有：</p>
<ul>
<li><strong><code>this</code></strong> <strong>对象</strong></li>
<li><strong><code>.class</code></strong> <strong>对象</strong></li>
<li><strong>任意指定的对象</strong></li>
</ul>
<p>​
在本单元的代码迭代中，笔者主要选择的锁对象是第三种——即任意指定的对象。</p>
<p>​
其实我们在设置同步块时，需要考量的方面有两个：粒度尽可能细、选择合适的保护资源</p>
<p>​ 那如此看来第三种锁对象的优越性就很明显了，主要的优点也有两个：</p>
<ul>
<li>缓解竞争：如果一个类中有多个需要同步的独立资源，可以为每个资源分配不同的锁对象。这样，访问不同资源的线程就<strong>不会互相阻塞</strong>，提高了并发性（锁的<strong>粒度更细</strong>）。</li>
<li>清晰性：无论在写还是改代码，总能<strong>明确同步的对象</strong>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unloadAllPassengersForUpdate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// copy curQuestList</span></span><br><span class="line">    	</span><br><span class="line">    	<span class="comment">// clear curQuestList</span></span><br><span class="line">        <span class="keyword">synchronized</span> (curQuestList) &#123; curQuestList.clear(); &#125;</span><br><span class="line">        <span class="comment">/* 1. 为了维护电梯中的请求列表，我们无需对elevator这整个对象进行同步，最好的选择应该是只维护这个可能做出修改导致并发问题的属性就可以 */</span></span><br><span class="line">    	<span class="comment">/* 2. 明确了同步对象，若是写作`synchronized(this)`，无法直观地看出为什么使用同步。</span></span><br><span class="line"><span class="comment">    	// perform output logic</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="锁的选择">2 锁的选择</h3>
<p>​
在本单元作业中，流行的锁主要就是两种，都是OOlens官方推荐的：<code>synchronized</code>
关键字实现的隐式锁和
<code>ReentrantLock</code>为代表的显式锁。他们的优劣对比我们用表格对比一下：</p>
<table>
<thead>
<tr>
<th>锁</th>
<th>synchronized</th>
<th>ReentrantLock</th>
</tr>
</thead>
<tbody>
<tr>
<td>复杂度</td>
<td>低，自动释放</td>
<td>高，手动释放</td>
</tr>
<tr>
<td>功能性</td>
<td>低，不够灵活</td>
<td>高，可中断获取锁、实现公平锁等</td>
</tr>
<tr>
<td>性能</td>
<td><strong>低竞争</strong>场景较优</td>
<td><strong>极高竞争</strong>场景较优</td>
</tr>
</tbody>
</table>
<p>​
在本单元作业中，笔者认为<code>synchronized</code>的简洁性和自动管理能满足要求，于是沿用至第三次作业，且性能与读写锁确实几乎持平。</p>
<h3 id="锁同步块与处理语句之间的关系">3
锁/同步块与处理语句之间的关系</h3>
<p>​
在锁中的处理语句虽然看上去是被保护的对象，但是其实我们上锁是为了保护所谓的<strong>“共享的状态与属性”</strong>，而同步块则是划定了一个<strong>“临界区”</strong>，在<strong>临界区</strong>中的代码可以单独访问或者修改其中的<strong>状态与属性</strong>。他们不仅保证了<strong>共享的状态与属性</strong>的<strong>变化</strong>对各个线程的<strong>可见性</strong>，还保证了临界区的操作的原子性，使之完整且连贯的执行完其中所有的操作。</p>
<p>​
如果说<strong>可见性</strong>可以用关键字<code>volatile</code>维护，那<strong>原子性</strong>的维护应该是锁所独有的。而且原子性这个性质强的出人意料😮，举例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> count; </span><br><span class="line">count++;</span><br><span class="line"><span class="comment">// 这个volatile关键字修饰的变量count只是做了一个自增的操作，怎么会引起线程安全问题？</span></span><br><span class="line"><span class="comment">// 原来count++不具原子性！它实际上包含了三个步骤：读-→改-→写，这就相当棘手，我们从代码层面无法维护它的原子性了。</span></span><br><span class="line"><span class="comment">// 这么简单的一个操作甚至都不是原子的，可见锁对多线程的不可或缺！</span></span><br></pre></td></tr></table></figure>
<h2 id="贰-调度器设计与调度策略">贰 调度器设计与调度策略</h2>
<h3 id="调度器设计与交互">1 调度器设计与交互</h3>
<p>​
尽管第一次作业的要求是直接分配，但是考虑到后期还是要采取不同分配策略，可能还要对比不同策略的性能，在第一次迭代作业中笔者便设计了一个<strong>分配策略接口</strong>，这让笔者在迭代与测试中感觉很是方便😃。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DispatchStrategy</span> &#123;</span><br><span class="line">    <span class="comment">// 同时作为DispatchThread的一个属性：</span></span><br><span class="line">    <span class="comment">// private final DispatchStrategy dispatchStrategy = new ***Dispatch();</span></span><br><span class="line">    Integer <span class="title function_">dispatch</span><span class="params">(PersonRequest request, HashMap&lt;Integer, QuestTable&gt; questTableMap)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectDispatch</span> <span class="keyword">implements</span> <span class="title class_">DispatchStrategy</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">dispatch</span><span class="params">(...)</span> &#123;</span><br><span class="line">        <span class="comment">// hw5直接分配</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriorityCostBasedDispatch</span> <span class="keyword">implements</span> <span class="title class_">DispatchStrategy</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">dispatch</span><span class="params">(...)</span> &#123;</span><br><span class="line">    	<span class="comment">// hw6&amp;7简易打分</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RandomDispatch</span> <span class="keyword">implements</span> <span class="title class_">DispatchStrategy</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">dispatch</span><span class="params">(...)</span> &#123;</span><br><span class="line">        <span class="comment">// 随机分配对比测试策略性能 </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​
我们一共设计了三种线程（不包括主线程），<strong>输入线程、分配器线程与电梯线程</strong>，分配器在二者之间完成<strong>管理总队列并分配请求</strong>给电梯的任务。三种线程构成了两个<strong>“生产者-消费者”模式</strong>：</p>
<ol type="1">
<li>输入线程是生产者，向总队列中添加请求信息；分配器线程是消费者，从中取出请求信息并分配。</li>
<li>分配器线程是生产者，在指派电梯后将请求添加进电梯请求表；各电梯线程是消费者，从各自的请求表中取出请求。</li>
</ol>
<h3 id="调度策略">2 调度策略</h3>
<p>​
第一次作业直接分配指定的电梯，各电梯采用<strong>LOOK策略</strong>各自运作。<del>（祖传的策略配方</del></p>
<p>​
第二次作业起，就正式进入了调度策略的构建了。最初想要综合各项指标去设计，但是后来发现收益不大的同时，难度却是大得夸张😭。最后采用的是一个<strong>简易的打分策略</strong>，因为没有时间和能力去调参。主要考虑了两个指标：<strong>ETA（预计用时）</strong>与容量惩罚。前者其实类似于影子电梯，而后者是出于另一个奇怪设计的考虑。因为笔者在第一次作业就设计了<strong>踢人策略</strong>，即当优先级较高的人想要乘梯，会将优先级较低的人踢出去😈。虽然在算加权时间上提高了性能，但是可能会导致耗电量增加。因此在后续迭代的分配中，笔者的想法是：除非竞争太过激烈，所有电梯都几近满员，否则尽量在<strong>分配的时候就减少踢人的概率</strong>。因此设立了第二项指标——容量惩罚，旨在给接近满员的电梯加惩罚分数，某种意义上也有点<strong>均匀分配</strong>的意思。</p>
<h2 id="叁-宏观回顾架构分析与总结">叁 宏观回顾：架构分析与总结</h2>
<h3 id="基于uml图的迭代分析">1 基于UML图的迭代分析</h3>
<p>​
这次整体迭代的内容主要集中在<code>Elevator</code>内部，整体架构保持稳定，请看最后一次迭代后的UML类图：</p>
<figure>
<img src="hw7UML.svg" alt="hw7classUML" />
<figcaption aria-hidden="true">hw7classUML</figcaption>
</figure>
<p>​
因为整体架构变化不大，就不画三张图了，整体稳定地采用<strong>“生产者-消费者”</strong>架构模式。第六次作业新增的是<strong>分配策略</strong>以及<strong>回调接口</strong>、第七次作业新增<strong>换乘层</strong>。</p>
<p>​
如类图所示，我们的设计可以对<strong>电梯改造</strong>进行扩展，修改运行楼层、速度以及容量等等，同时策略接口也允许我们对<strong>多策略进行扩展</strong>，甚至可以随着竞争压力大小切换策略。最后，我们为电梯设计的多模式，可以相对轻松地<strong>应对类似临时调度与更新的需求</strong>，或者对电梯进行还原。</p>
<p>​ UML协作图如下：</p>
<figure>
<img src="hw7sequenceUML.svg" alt="hw7sequenceUML" />
<figcaption aria-hidden="true">hw7sequenceUML</figcaption>
</figure>
<h3 id="识别稳定与易变">2 识别稳定与易变</h3>
<p>​
首先，毋庸置疑的是总的<strong>流水线架构</strong>始终保持稳定，不随着迭代的变化而修改，变化的主要是线程内部的指令。其次，在我们处理请求的时候，我们发现无论是哪种请求，它都是<code>Request</code>的子类，第一次迭代的时候还不明确<code>Request</code>存在的意义，后来才能理解，是它为我们提供了各种请求的“数据结构”，并在共性特征中以父类的方式<strong>保持各种请求的统一</strong>。</p>
<p>​
与之相对的，实现的线程运行细节则会跟随用户需求发生变化，包括临时调度、更新，甚至调度策略也是根据用户是否指定电梯来更改的，他们相对来说就是易变的。</p>
<p>​ 大结构稳定，小细节易变，这完全符合我们做项目迭代的完美状况。</p>
<h2 id="肆-特别讨论双轿厢问题">肆 特别讨论：双轿厢问题</h2>
<p>​
学长巧妙的<code>TransFloor</code>类的设计也是被我用上了😊，通过此类对换乘层进行管理。首先从面向对象的角度考虑，如果你要在电梯内部运行的时候，得知另一个电梯的运行状态，那可太影响类内部的封装性了。其次，出于对对称性的考虑，应该要设计一个类出来，保证它对两个电梯的态度都是<strong>"公平对等"</strong>的。</p>
<p>​ 那具体如何避免碰撞呢？说白了就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">Occupy</span><span class="params">()</span> &#123; <span class="comment">// 电梯A进去前要问问：“换乘层有没有梯？”</span></span><br><span class="line">        <span class="keyword">if</span> (!isOccupied) &#123; <span class="comment">// 换乘层：“没有！”</span></span><br><span class="line">            isOccupied = <span class="literal">true</span>; <span class="comment">// 电梯A：“窝莱拉！”</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// *换乘层拒绝了电梯A*</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">ReleaseAndNotify</span><span class="params">()</span> &#123; <span class="comment">// 电梯A出来后要告诉换乘层：“我走啦！”</span></span><br><span class="line">        isOccupied = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.notifyAll(); <span class="comment">// 换乘层：“告诉大家我有空了！” </span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>​
此外，便是要实现双轿厢<strong>同步开始改造</strong>。其实同理，但是我们引入两个布尔值，在一个方法里完成<strong>互斥</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">synchronizeElevators</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isFirstReady.get()) &#123; <span class="comment">// 第一个准备好了</span></span><br><span class="line">            isFirstReady.set(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">while</span> (!bothReady.get()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 第二个准备好了</span></span><br><span class="line">            bothReady.set(<span class="literal">true</span>); <span class="comment">// 更改状态并通知</span></span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="伍-bugdebug">伍 BUG&amp;DEBUG</h2>
<p>​ <del>最折磨的一集😈</del></p>
<p>​
先说DEBUG，不会用多线程调试，也有大佬说多线程调试给到的信息过少，根本无法定位错误。因此果断采用<strong>Print大法</strong>，其实不知道哪位先提出的，就是统一设置一个debug开关，可以大幅减少工作量。我在公共定义类中的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">debug</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">debugp</span><span class="params">(String str)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">           System.out.println(str);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>​
再说说BUG，这个单元的bug主要都围绕着踢人策略。第一次作业中就是为了实现踢人导致的粗心错误，具体而言即当一个优先级较高的请求将另一个优先级较低的请求踢掉后，没有输入上电梯的信息😭，因此导致了上电梯但没有记录的鬼魂事件👻。</p>
<p>​
对于第二、三次作业陆续出现的临时操作：<code>SCHE</code>与<code>UPDATE</code>，它们一方面在运行时不能接人，另一方面要把电梯内外的请求清空。对于不能接人这一要求，我在分配器线程与电梯线程中通过延迟输出RECEIVE的方式解决；而后者中清空请求列表相对棘手，为了保持低耦合度，电梯类内部不应该能洞察到外部总列表的信息，因此把电梯列表里的请求返还给总请求列表这里用到了<strong>回调接口</strong>，而没有直接让电梯能在内部对总请求队列进行修改。</p>
<p>​
第二次作业中第一次尝试写回调接口，最后出了很多线程问题，太赶时间导致中测甚至爆了两个点。🤦‍</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数接口声明</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span> <span class="comment">// 标记为函数式接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestReturnCallback</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理一个从电梯返还的请求。</span></span><br><span class="line"><span class="comment">     * DispatchThread应该将此请求重新加入主请求队列。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> returnedRequest 从电梯中移除并需要重新调度的请求。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">returnRequest</span><span class="params">(PersonRequest returnedRequest)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Disapatch Thread中的属性</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RequestReturnCallback</span> <span class="variable">callback</span> <span class="operator">=</span> (returnedRequest) -&gt; &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.requestQueue) &#123;</span><br><span class="line">        <span class="built_in">this</span>.requestQueue.addRequest(returnedRequest);</span><br><span class="line">        <span class="built_in">this</span>.requestQueue.notifyAll(); <span class="comment">// 唤醒可能等待的 run() 循环</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Elevator中初始化接口实例</span></span><br><span class="line"><span class="built_in">this</span>.returnCallback = returnCallback; </span><br><span class="line"><span class="comment">// Elevator中复制请求并重新放入队列</span></span><br><span class="line"><span class="type">PersonRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PersonRequest</span>(newFloorStr,request.getToFloor(), 											request.getPersonId(), request.getPriority());</span><br><span class="line"><span class="built_in">this</span>.returnCallback.returnRequest(newRequest);</span><br></pre></td></tr></table></figure>
<h2 id="陆-心得体会">陆 心得体会</h2>
<h3 id="线程安全">1 线程安全</h3>
<p>​
这个单元的主题就是多线程编程，其中最重要的就是保护线程的安全。我在编写代码的时候会有意识地尽可能少上锁，因为在第五次作业debug时曾疯狂加锁，发现容易<strong>导致死锁</strong>等问题，程序甚至无法正常运行。因此在第六次作业分配策略中计算ETA时，我没有选择像传统影子电梯为<strong>每个电梯都挂锁</strong>，而是选择为电梯拍下快照，第一直觉是误差增大，但是想想影子电梯也会有一定的误差后，我就觉得这点误差可以接收了。我只需要在<strong>拍快照的时候维护电梯线程的数据安全</strong>，真正调用分配策略的时候，电梯就可以正常运行了。少用一些同步块，或者有意识减小同步块的颗粒度都是可以<strong>保证正确</strong>的同时<strong>提升性能</strong>的。另外就是同步块到底同步的是谁，能不能锁住，在debug的时候要仔细推敲，避免被小bug硬控🤬。</p>
<h3 id="层次化设计">2 层次化设计</h3>
<p>​
笨人没有用到太多的设计模式，但是紧紧抓紧了“生产者-消费者”的大腿，构建出来的“流水线”设计让人在写代码和改代码的时候都可以思路清晰地完成。更重要的是在debug时，可以通过输出调试法，一步一步定位出错的环节，有一种类似顺藤摸瓜的感觉。<strong>峰回路转，但是你确信、也确实一定能找到问题所在。</strong></p>
<h2 id="后记">后记</h2>
<p>​
交完了OO单元总结，后面的话就是想在网站上说的了（bushi）。也没什么不能说的，我感觉我有一种莫名的慢热，当我写总结的时候，我才对OO展现出了比较浓厚的兴趣🧐，希望这段时间把学习状态控制好，最主要是让我睡个好觉呗😴，已经连续快一周没睡好了。</p>
<p>​ 好的！言尽于此，周末也快要告一段落了，抓紧去玩一会！🤩</p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          
          <li class="next">
            <a href="/en/BUAA-OSLab2实验总结/" data-toggle="tooltip" data-placement="top" title="BUAA-OSLab2实验总结">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '',
      clientSecret: '',
      repo: '',
      owner: '',
      admin: '',
      id: 'Sat Apr 19 2025 16:02:05 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: false,
      language: 'en',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#buaa_oo2025%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">BUAA_OO2025第二单元总结</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%A3%B9-%E5%90%8C%E6%AD%A5%E5%9D%97%E4%B8%8E%E9%94%81"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">壹 同步块与锁</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%90%8C%E6%AD%A5%E5%9D%97%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">1 同步块的设置</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%94%81%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">2 锁的选择</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%94%81%E5%90%8C%E6%AD%A5%E5%9D%97%E4%B8%8E%E5%A4%84%E7%90%86%E8%AF%AD%E5%8F%A5%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">3
锁&#x2F;同步块与处理语句之间的关系</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%B4%B0-%E8%B0%83%E5%BA%A6%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">贰 调度器设计与调度策略</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E4%BA%A4%E4%BA%92"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">1 调度器设计与交互</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">2 调度策略</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%8F%81-%E5%AE%8F%E8%A7%82%E5%9B%9E%E9%A1%BE%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90%E4%B8%8E%E6%80%BB%E7%BB%93"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">叁 宏观回顾：架构分析与总结</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8Euml%E5%9B%BE%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%88%86%E6%9E%90"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">1 基于UML图的迭代分析</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%AF%86%E5%88%AB%E7%A8%B3%E5%AE%9A%E4%B8%8E%E6%98%93%E5%8F%98"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">2 识别稳定与易变</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E8%82%86-%E7%89%B9%E5%88%AB%E8%AE%A8%E8%AE%BA%E5%8F%8C%E8%BD%BF%E5%8E%A2%E9%97%AE%E9%A2%98"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">肆 特别讨论：双轿厢问题</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BC%8D-bugdebug"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">伍 BUG&amp;DEBUG</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%99%86-%E5%BF%83%E5%BE%97%E4%BD%93%E4%BC%9A"><span class="toc-nav-number">1.7.</span> <span class="toc-nav-text">陆 心得体会</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-nav-number">1.7.1.</span> <span class="toc-nav-text">1 线程安全</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%B1%82%E6%AC%A1%E5%8C%96%E8%AE%BE%E8%AE%A1"><span class="toc-nav-number">1.7.2.</span> <span class="toc-nav-text">2 层次化设计</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-nav-number">1.8.</span> <span class="toc-nav-text">后记</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#OO" title="OO">OO</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/S7AM1NA">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          S7AM1NA
          2025
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  
    <!-- LangSelect start -->
    <script type="text/javascript" src="/js/langselect.js"></script>
    <!-- LangSelect end -->
  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  
    <!-- Line start -->
    <script async="text/javascript" src="/js/line.js"></script>
    <!-- Line end -->
  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://s7am1na.github.io/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
